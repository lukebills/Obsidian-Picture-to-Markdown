/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var qr=Object.defineProperty;var Cn=Object.getOwnPropertyDescriptor;var vn=Object.getOwnPropertyNames;var On=Object.prototype.hasOwnProperty;var $n=(s,e)=>{for(var t in e)qr(s,t,{get:e[t],enumerable:!0})},kn=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of vn(e))!On.call(s,n)&&n!==t&&qr(s,n,{get:()=>e[n],enumerable:!(r=Cn(e,n))||r.enumerable});return s};var Tn=s=>kn(qr({},"__esModule",{value:!0}),s);var Yi={};$n(Yi,{default:()=>Dr});module.exports=Tn(Yi);var O=require("obsidian");function x(s,e,t,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(s,t):n?n.value=t:e.set(s,t),t}function o(s,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(s):r?r.value:e.get(s)}var Hr=function(){let{crypto:s}=globalThis;if(s!=null&&s.randomUUID)return Hr=s.randomUUID.bind(s),s.randomUUID();let e=new Uint8Array(1),t=s?()=>s.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,r=>(+r^t()&15>>+r/4).toString(16))};function Jt(s){return typeof s=="object"&&s!==null&&("name"in s&&s.name==="AbortError"||"message"in s&&String(s.message).includes("FetchRequestCanceledException"))}var Xt=s=>{if(s instanceof Error)return s;if(typeof s=="object"&&s!==null){try{if(Object.prototype.toString.call(s)==="[object Error]"){let e=new Error(s.message,s.cause?{cause:s.cause}:{});return s.stack&&(e.stack=s.stack),s.cause&&!e.cause&&(e.cause=s.cause),s.name&&(e.name=s.name),e}}catch(e){}try{return new Error(JSON.stringify(s))}catch(e){}}return new Error(s)};var w=class extends Error{},L=class extends w{constructor(e,t,r,n){super(`${L.makeMessage(e,t,r)}`),this.status=e,this.headers=n,this.requestID=n==null?void 0:n.get("x-request-id"),this.error=t;let i=t;this.code=i==null?void 0:i.code,this.param=i==null?void 0:i.param,this.type=i==null?void 0:i.type}static makeMessage(e,t,r){let n=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,r,n){if(!e||!n)return new ye({message:r,cause:Xt(t)});let i=t==null?void 0:t.error;return e===400?new nt(e,i,r,n):e===401?new it(e,i,r,n):e===403?new at(e,i,r,n):e===404?new ot(e,i,r,n):e===409?new lt(e,i,r,n):e===422?new ct(e,i,r,n):e===429?new ut(e,i,r,n):e>=500?new ft(e,i,r,n):new L(e,i,r,n)}},j=class extends L{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},ye=class extends L{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},be=class extends ye{constructor({message:e}={}){super({message:e!=null?e:"Request timed out."})}},nt=class extends L{},it=class extends L{},at=class extends L{},ot=class extends L{},lt=class extends L{},ct=class extends L{},ut=class extends L{},ft=class extends L{},dt=class extends w{constructor(){super("Could not parse response content as the length limit was reached")}},ht=class extends w{constructor(){super("Could not parse response content as the request was rejected by the content filter")}},se=class extends Error{constructor(e){super(e)}};var Nn=/^[a-z][a-z0-9+.-]*:/i,Os=s=>Nn.test(s),J=s=>(J=Array.isArray,J(s)),Jr=J;function Xr(s){return typeof s!="object"?{}:s!=null?s:{}}function $s(s){if(!s)return!0;for(let e in s)return!1;return!0}function ks(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function Kt(s){return s!=null&&typeof s=="object"&&!Array.isArray(s)}var Ts=(s,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new w(`${s} must be an integer`);if(e<0)throw new w(`${s} must be a positive integer`);return e};var Fs=s=>{try{return JSON.parse(s)}catch(e){return}};var ne=s=>new Promise(e=>setTimeout(e,s));var xe="5.20.2";var Ls=()=>typeof window!="undefined"&&typeof window.document!="undefined"&&typeof navigator!="undefined";function Mn(){return typeof Deno!="undefined"&&Deno.build!=null?"deno":typeof EdgeRuntime!="undefined"?"edge":Object.prototype.toString.call(typeof globalThis.process!="undefined"?globalThis.process:0)==="[object process]"?"node":"unknown"}var Ln=()=>{var t,r,n,i,a;let s=Mn();if(s==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xe,"X-Stainless-OS":Ms(Deno.build.os),"X-Stainless-Arch":Ns(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:(r=(t=Deno.version)==null?void 0:t.deno)!=null?r:"unknown"};if(typeof EdgeRuntime!="undefined")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xe,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(s==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xe,"X-Stainless-OS":Ms((n=globalThis.process.platform)!=null?n:"unknown"),"X-Stainless-Arch":Ns((i=globalThis.process.arch)!=null?i:"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":(a=globalThis.process.version)!=null?a:"unknown"};let e=Bn();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xe,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":xe,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Bn(){if(typeof navigator=="undefined"||!navigator)return null;let s=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of s){let r=t.exec(navigator.userAgent);if(r){let n=r[1]||0,i=r[2]||0,a=r[3]||0;return{browser:e,version:`${n}.${i}.${a}`}}}return null}var Ns=s=>s==="x32"?"x32":s==="x86_64"||s==="x64"?"x64":s==="arm"?"arm":s==="aarch64"||s==="arm64"?"arm64":s?`other:${s}`:"unknown",Ms=s=>(s=s.toLowerCase(),s.includes("ios")?"iOS":s==="android"?"Android":s==="darwin"?"MacOS":s==="win32"?"Windows":s==="freebsd"?"FreeBSD":s==="openbsd"?"OpenBSD":s==="linux"?"Linux":s?`Other:${s}`:"Unknown"),ur,Bs=()=>ur!=null?ur:ur=Ln();function Us(){if(typeof fetch!="undefined")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function Kr(...s){let e=globalThis.ReadableStream;if(typeof e=="undefined")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...s)}function fr(s){let e=Symbol.asyncIterator in s?s[Symbol.asyncIterator]():s[Symbol.iterator]();return Kr({start(){},async pull(t){let{done:r,value:n}=await e.next();r?t.close():t.enqueue(n)},async cancel(){var t;await((t=e.return)==null?void 0:t.call(e))}})}function Vr(s){if(s[Symbol.asyncIterator])return s;let e=s.getReader();return{async next(){try{let t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function js(s){var r,n;if(s===null||typeof s!="object")return;if(s[Symbol.asyncIterator]){await((n=(r=s[Symbol.asyncIterator]()).return)==null?void 0:n.call(r));return}let e=s.getReader(),t=e.cancel();e.releaseLock(),await t}var Ws=({headers:s,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)});var dr="RFC3986",Gr=s=>String(s),hr={RFC1738:s=>String(s).replace(/%20/g,"+"),RFC3986:Gr},Qr="RFC1738";var mr=(s,e)=>{var t;return mr=(t=Object.hasOwn)!=null?t:Function.prototype.call.bind(Object.prototype.hasOwnProperty),mr(s,e)},ie=(()=>{let s=[];for(let e=0;e<256;++e)s.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return s})();var Yr=1024,Ds=(s,e,t,r,n)=>{if(s.length===0)return s;let i=s;if(typeof s=="symbol"?i=Symbol.prototype.toString.call(s):typeof s!="string"&&(i=String(s)),t==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(l){return"%26%23"+parseInt(l.slice(2),16)+"%3B"});let a="";for(let l=0;l<i.length;l+=Yr){let u=i.length>=Yr?i.slice(l,l+Yr):i,c=[];for(let m=0;m<u.length;++m){let d=u.charCodeAt(m);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||n===Qr&&(d===40||d===41)){c[c.length]=u.charAt(m);continue}if(d<128){c[c.length]=ie[d];continue}if(d<2048){c[c.length]=ie[192|d>>6]+ie[128|d&63];continue}if(d<55296||d>=57344){c[c.length]=ie[224|d>>12]+ie[128|d>>6&63]+ie[128|d&63];continue}m+=1,d=65536+((d&1023)<<10|u.charCodeAt(m)&1023),c[c.length]=ie[240|d>>18]+ie[128|d>>12&63]+ie[128|d>>6&63]+ie[128|d&63]}a+=c.join("")}return a};function qs(s){return!s||typeof s!="object"?!1:!!(s.constructor&&s.constructor.isBuffer&&s.constructor.isBuffer(s))}function zr(s,e){if(J(s)){let t=[];for(let r=0;r<s.length;r+=1)t.push(e(s[r]));return t}return e(s)}var Hs={brackets(s){return String(s)+"[]"},comma:"comma",indices(s,e){return String(s)+"["+e+"]"},repeat(s){return String(s)}},Js=function(s,e){Array.prototype.push.apply(s,J(e)?e:[e])},pr,W={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:Ds,encodeValuesOnly:!1,format:dr,formatter:Gr,indices:!1,serializeDate(s){return(pr!=null?pr:pr=Function.prototype.call.bind(Date.prototype.toISOString))(s)},skipNulls:!1,strictNullHandling:!1};function Wn(s){return typeof s=="string"||typeof s=="number"||typeof s=="boolean"||typeof s=="symbol"||typeof s=="bigint"}var Zr={};function Xs(s,e,t,r,n,i,a,l,u,c,m,d,g,p,y,A,b,F){let P=s,M=F,$=0,I=!1;for(;(M=M.get(Zr))!==void 0&&!I;){let R=M.get(s);if($+=1,typeof R!="undefined"){if(R===$)throw new RangeError("Cyclic object value");I=!0}typeof M.get(Zr)=="undefined"&&($=0)}if(typeof c=="function"?P=c(e,P):P instanceof Date?P=g==null?void 0:g(P):t==="comma"&&J(P)&&(P=zr(P,function(R){return R instanceof Date?g==null?void 0:g(R):R})),P===null){if(i)return u&&!A?u(e,W.encoder,b,"key",p):e;P=""}if(Wn(P)||qs(P)){if(u){let R=A?e:u(e,W.encoder,b,"key",p);return[(y==null?void 0:y(R))+"="+(y==null?void 0:y(u(P,W.encoder,b,"value",p)))]}return[(y==null?void 0:y(e))+"="+(y==null?void 0:y(String(P)))]}let U=[];if(typeof P=="undefined")return U;let T;if(t==="comma"&&J(P))A&&u&&(P=zr(P,u)),T=[{value:P.length>0?P.join(",")||null:void 0}];else if(J(c))T=c;else{let R=Object.keys(P);T=m?R.sort(m):R}let v=l?String(e).replace(/\./g,"%2E"):String(e),C=r&&J(P)&&P.length===1?v+"[]":v;if(n&&J(P)&&P.length===0)return C+"[]";for(let R=0;R<T.length;++R){let N=T[R],k=typeof N=="object"&&typeof N.value!="undefined"?N.value:P[N];if(a&&k===null)continue;let Z=d&&l?N.replace(/\./g,"%2E"):N,fe=J(P)?typeof t=="function"?t(C,Z):C:C+(d?"."+Z:"["+Z+"]");F.set(s,$);let V=new WeakMap;V.set(Zr,F),Js(U,Xs(k,fe,t,r,n,i,a,l,t==="comma"&&A&&J(P)?null:u,c,m,d,g,p,y,A,b,V))}return U}function Dn(s=W){if(typeof s.allowEmptyArrays!="undefined"&&typeof s.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof s.encodeDotInKeys!="undefined"&&typeof s.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(s.encoder!==null&&typeof s.encoder!="undefined"&&typeof s.encoder!="function")throw new TypeError("Encoder has to be a function.");let e=s.charset||W.charset;if(typeof s.charset!="undefined"&&s.charset!=="utf-8"&&s.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=dr;if(typeof s.format!="undefined"){if(!mr(hr,s.format))throw new TypeError("Unknown format option provided.");t=s.format}let r=hr[t],n=W.filter;(typeof s.filter=="function"||J(s.filter))&&(n=s.filter);let i;if(s.arrayFormat&&s.arrayFormat in Hs?i=s.arrayFormat:"indices"in s?i=s.indices?"indices":"repeat":i=W.arrayFormat,"commaRoundTrip"in s&&typeof s.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");let a=typeof s.allowDots=="undefined"?s.encodeDotInKeys?!0:W.allowDots:!!s.allowDots;return{addQueryPrefix:typeof s.addQueryPrefix=="boolean"?s.addQueryPrefix:W.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof s.allowEmptyArrays=="boolean"?!!s.allowEmptyArrays:W.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof s.charsetSentinel=="boolean"?s.charsetSentinel:W.charsetSentinel,commaRoundTrip:!!s.commaRoundTrip,delimiter:typeof s.delimiter=="undefined"?W.delimiter:s.delimiter,encode:typeof s.encode=="boolean"?s.encode:W.encode,encodeDotInKeys:typeof s.encodeDotInKeys=="boolean"?s.encodeDotInKeys:W.encodeDotInKeys,encoder:typeof s.encoder=="function"?s.encoder:W.encoder,encodeValuesOnly:typeof s.encodeValuesOnly=="boolean"?s.encodeValuesOnly:W.encodeValuesOnly,filter:n,format:t,formatter:r,serializeDate:typeof s.serializeDate=="function"?s.serializeDate:W.serializeDate,skipNulls:typeof s.skipNulls=="boolean"?s.skipNulls:W.skipNulls,sort:typeof s.sort=="function"?s.sort:null,strictNullHandling:typeof s.strictNullHandling=="boolean"?s.strictNullHandling:W.strictNullHandling}}function es(s,e={}){let t=s,r=Dn(e),n,i;typeof r.filter=="function"?(i=r.filter,t=i("",t)):J(r.filter)&&(i=r.filter,n=i);let a=[];if(typeof t!="object"||t===null)return"";let l=Hs[r.arrayFormat],u=l==="comma"&&r.commaRoundTrip;n||(n=Object.keys(t)),r.sort&&n.sort(r.sort);let c=new WeakMap;for(let g=0;g<n.length;++g){let p=n[g];r.skipNulls&&t[p]===null||Js(a,Xs(t[p],p,l,u,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}let m=a.join(r.delimiter),d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),m.length>0?d+m:""}function Ks(s){let e=0;for(let n of s)e+=n.length;let t=new Uint8Array(e),r=0;for(let n of s)t.set(n,r),r+=n.length;return t}var gr;function mt(s){let e;return(gr!=null?gr:(e=new globalThis.TextEncoder,gr=e.encode.bind(e)))(s)}var _r;function ts(s){let e;return(_r!=null?_r:(e=new globalThis.TextDecoder,_r=e.decode.bind(e)))(s)}var G,Q,Le=class{constructor(){G.set(this,void 0),Q.set(this,void 0),x(this,G,new Uint8Array,"f"),x(this,Q,null,"f")}decode(e){if(e==null)return[];let t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?mt(e):e;x(this,G,Ks([o(this,G,"f"),t]),"f");let r=[],n;for(;(n=Hn(o(this,G,"f"),o(this,Q,"f")))!=null;){if(n.carriage&&o(this,Q,"f")==null){x(this,Q,n.index,"f");continue}if(o(this,Q,"f")!=null&&(n.index!==o(this,Q,"f")+1||n.carriage)){r.push(ts(o(this,G,"f").subarray(0,o(this,Q,"f")-1))),x(this,G,o(this,G,"f").subarray(o(this,Q,"f")),"f"),x(this,Q,null,"f");continue}let i=o(this,Q,"f")!==null?n.preceding-1:n.preceding,a=ts(o(this,G,"f").subarray(0,i));r.push(a),x(this,G,o(this,G,"f").subarray(n.index),"f"),x(this,Q,null,"f")}return r}flush(){return o(this,G,"f").length?this.decode(`
`):[]}};G=new WeakMap,Q=new WeakMap;Le.NEWLINE_CHARS=new Set([`
`,"\r"]);Le.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Hn(s,e){for(let n=e!=null?e:0;n<s.length;n++){if(s[n]===10)return{preceding:n,index:n+1,carriage:!1};if(s[n]===13)return{preceding:n,index:n+1,carriage:!0}}return null}function Vs(s){for(let r=0;r<s.length-1;r++){if(s[r]===10&&s[r+1]===10||s[r]===13&&s[r+1]===13)return r+2;if(s[r]===13&&s[r+1]===10&&r+3<s.length&&s[r+2]===13&&s[r+3]===10)return r+4}return-1}var yr={off:0,error:200,warn:300,info:400,debug:500},rs=(s,e,t)=>{if(s){if(ks(yr,s))return s;B(t).warn(`${e} was set to ${JSON.stringify(s)}, expected one of ${JSON.stringify(Object.keys(yr))}`)}};function Vt(){}function wr(s,e,t){return!e||yr[s]>yr[t]?Vt:e[s].bind(e)}var Jn={error:Vt,warn:Vt,info:Vt,debug:Vt},Gs=new WeakMap;function B(s){var i;let e=s.logger,t=(i=s.logLevel)!=null?i:"off";if(!e)return Jn;let r=Gs.get(e);if(r&&r[0]===t)return r[1];let n={error:wr("error",e,t),warn:wr("warn",e,t),info:wr("info",e,t),debug:wr("debug",e,t)};return Gs.set(e,[t,n]),n}var de=s=>(s.options&&(s.options={...s.options},delete s.options.headers),s.headers&&(s.headers=Object.fromEntries((s.headers instanceof Headers?[...s.headers]:Object.entries(s.headers)).map(([e,t])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":t]))),"retryOfRequestLogID"in s&&(s.retryOfRequestLogID&&(s.retryOf=s.retryOfRequestLogID),delete s.retryOfRequestLogID),s);var Gt,X=class{constructor(e,t,r){this.iterator=e,Gt.set(this,void 0),this.controller=t,x(this,Gt,r,"f")}static fromSSEResponse(e,t,r){let n=!1,i=r?B(r):console;async function*a(){if(n)throw new w("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let l=!1;try{for await(let u of Xn(e,t))if(!l){if(u.data.startsWith("[DONE]")){l=!0;continue}if(u.event===null||!u.event.startsWith("thread.")){let c;try{c=JSON.parse(u.data)}catch(m){throw i.error("Could not parse message into JSON:",u.data),i.error("From chunk:",u.raw),m}if(c&&c.error)throw new L(void 0,c.error,void 0,e.headers);yield c}else{let c;try{c=JSON.parse(u.data)}catch(m){throw console.error("Could not parse message into JSON:",u.data),console.error("From chunk:",u.raw),m}if(u.event=="error")throw new L(void 0,c.error,c.message,void 0);yield{event:u.event,data:c}}}l=!0}catch(u){if(Jt(u))return;throw u}finally{l||t.abort()}}return new X(a,t,r)}static fromReadableStream(e,t,r){let n=!1;async function*i(){let l=new Le,u=Vr(e);for await(let c of u)for(let m of l.decode(c))yield m;for(let c of l.flush())yield c}async function*a(){if(n)throw new w("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let l=!1;try{for await(let u of i())l||u&&(yield JSON.parse(u));l=!0}catch(u){if(Jt(u))return;throw u}finally{l||t.abort()}}return new X(a,t,r)}[(Gt=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),n=i=>({next:()=>{if(i.length===0){let a=r.next();e.push(a),t.push(a)}return i.shift()}});return[new X(()=>n(e),this.controller,o(this,Gt,"f")),new X(()=>n(t),this.controller,o(this,Gt,"f"))]}toReadableStream(){let e=this,t;return Kr({async start(){t=e[Symbol.asyncIterator]()},async pull(r){try{let{value:n,done:i}=await t.next();if(i)return r.close();let a=mt(JSON.stringify(n)+`
`);r.enqueue(a)}catch(n){r.error(n)}},async cancel(){var r;await((r=t.return)==null?void 0:r.call(t))}})}};async function*Xn(s,e){if(!s.body)throw e.abort(),typeof globalThis.navigator!="undefined"&&globalThis.navigator.product==="ReactNative"?new w("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new w("Attempted to iterate over a response with no body");let t=new ss,r=new Le,n=Vr(s.body);for await(let i of Kn(n))for(let a of r.decode(i)){let l=t.decode(a);l&&(yield l)}for(let i of r.flush()){let a=t.decode(i);a&&(yield a)}}async function*Kn(s){let e=new Uint8Array;for await(let t of s){if(t==null)continue;let r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?mt(t):t,n=new Uint8Array(e.length+r.length);n.set(e),n.set(r,e.length),e=n;let i;for(;(i=Vs(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}var ss=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,n]=Vn(e,":");return n.startsWith(" ")&&(n=n.substring(1)),t==="event"?this.event=n:t==="data"&&this.data.push(n),null}};function Vn(s,e){let t=s.indexOf(e);return t!==-1?[s.substring(0,t),e,s.substring(t+e.length)]:[s,"",""]}async function br(s,e){let{response:t,requestLogID:r,retryOfRequestLogID:n,startTime:i}=e,a=await(async()=>{var d;if(e.options.stream)return B(s).debug("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller,s):X.fromSSEResponse(t,e.controller,s);if(t.status===204)return null;if(e.options.__binaryResponse)return t;let l=t.headers.get("content-type"),u=(d=l==null?void 0:l.split(";")[0])==null?void 0:d.trim();if((u==null?void 0:u.includes("application/json"))||(u==null?void 0:u.endsWith("+json"))){let g=await t.json();return ns(g,t)}return await t.text()})();return B(s).debug(`[${r}] response parsed`,de({retryOfRequestLogID:n,url:t.url,status:t.status,body:a,durationMs:Date.now()-i})),a}function ns(s,e){return!s||typeof s!="object"||Array.isArray(s)?s:Object.defineProperty(s,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var Qt,he=class extends Promise{constructor(e,t,r=br){super(n=>{n(null)}),this.responsePromise=t,this.parseResponse=r,Qt.set(this,void 0),x(this,Qt,e,"f")}_thenUnwrap(e){return new he(o(this,Qt,"f"),this.responsePromise,async(t,r)=>ns(e(await this.parseResponse(t,r),r),r.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(o(this,Qt,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}};Qt=new WeakMap;var xr,Yt=class{constructor(e,t,r,n){xr.set(this,void 0),x(this,xr,e,"f"),this.options=n,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new w("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await o(this,xr,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(xr=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},zt=class extends he{constructor(e,t,r){super(e,t,async(n,i)=>new r(n,i.response,await br(n,i),i.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},ae=class extends Yt{constructor(e,t,r,n){super(e,t,r,n),this.data=r.data||[],this.object=r.object}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}nextPageRequestOptions(){return null}},E=class extends Yt{constructor(e,t,r,n){super(e,t,r,n),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){var r;let e=this.getPaginatedItems(),t=(r=e[e.length-1])==null?void 0:r.id;return t?{...this.options,query:{...Xr(this.options.query),after:t}}:null}},Ar=class extends Yt{constructor(e,t,r,n){super(e,t,r,n),this.data=r.data||[],this.has_more=r.has_more||!1,this.last_id=r.last_id||""}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){let e=this.last_id;return e?{...this.options,query:{...Xr(this.options.query),after:e}}:null}};var as=()=>{var s;if(typeof File=="undefined"){let{process:e}=globalThis,t=typeof((s=e==null?void 0:e.versions)==null?void 0:s.node)=="string"&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function pt(s,e,t){return as(),new File(s,e!=null?e:"unknown_file",t)}function Zt(s){return(typeof s=="object"&&s!==null&&("name"in s&&s.name&&String(s.name)||"url"in s&&s.url&&String(s.url)||"filename"in s&&s.filename&&String(s.filename)||"path"in s&&s.path&&String(s.path))||"").split(/[\\/]/).pop()||void 0}var os=s=>s!=null&&typeof s=="object"&&typeof s[Symbol.asyncIterator]=="function";var Y=async(s,e)=>({...s,body:await Yn(s.body,e)}),Qs=new WeakMap;function Qn(s){let e=typeof s=="function"?s:s.fetch,t=Qs.get(e);if(t)return t;let r=(async()=>{try{let n="Response"in e?e.Response:(await e("data:,")).constructor,i=new FormData;return i.toString()!==await new n(i).text()}catch(n){return!0}})();return Qs.set(e,r),r}var Yn=async(s,e)=>{if(!await Qn(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let t=new FormData;return await Promise.all(Object.entries(s||{}).map(([r,n])=>is(t,r,n))),t},zn=s=>s instanceof Blob&&"name"in s;var is=async(s,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")s.append(e,String(t));else if(t instanceof Response)s.append(e,pt([await t.blob()],Zt(t)));else if(os(t))s.append(e,pt([await new Response(fr(t)).blob()],Zt(t)));else if(zn(t))s.append(e,t,Zt(t));else if(Array.isArray(t))await Promise.all(t.map(r=>is(s,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,n])=>is(s,`${e}[${r}]`,n)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Ys=s=>s!=null&&typeof s=="object"&&typeof s.size=="number"&&typeof s.type=="string"&&typeof s.text=="function"&&typeof s.slice=="function"&&typeof s.arrayBuffer=="function",Zn=s=>s!=null&&typeof s=="object"&&typeof s.name=="string"&&typeof s.lastModified=="number"&&Ys(s),ei=s=>s!=null&&typeof s=="object"&&typeof s.url=="string"&&typeof s.blob=="function";async function Ir(s,e,t){if(as(),s=await s,Zn(s))return s instanceof File?s:pt([await s.arrayBuffer()],s.name);if(ei(s)){let n=await s.blob();return e||(e=new URL(s.url).pathname.split(/[\\/]/).pop()),pt(await ls(n),e,t)}let r=await ls(s);if(e||(e=Zt(s)),!(t!=null&&t.type)){let n=r.find(i=>typeof i=="object"&&"type"in i&&i.type);typeof n=="string"&&(t={...t,type:n})}return pt(r,e,t)}async function ls(s){var t;let e=[];if(typeof s=="string"||ArrayBuffer.isView(s)||s instanceof ArrayBuffer)e.push(s);else if(Ys(s))e.push(s instanceof Blob?s:await s.arrayBuffer());else if(os(s))for await(let r of s)e.push(...await ls(r));else{let r=(t=s==null?void 0:s.constructor)==null?void 0:t.name;throw new Error(`Unexpected data type: ${typeof s}${r?`; constructor: ${r}`:""}${ti(s)}`)}return e}function ti(s){return typeof s!="object"||s===null?"":`; props: [${Object.getOwnPropertyNames(s).map(t=>`"${t}"`).join(", ")}]`}var h=class{constructor(e){this._client=e}};function Zs(s){return s.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}var zs=Object.freeze(Object.create(null)),si=(s=Zs)=>function(t,...r){if(t.length===1)return t[0];let n=!1,i=[],a=t.reduce((m,d,g)=>{var A,b,F;/[?#]/.test(d)&&(n=!0);let p=r[g],y=(n?encodeURIComponent:s)(""+p);return g!==r.length&&(p==null||typeof p=="object"&&p.toString===((F=Object.getPrototypeOf((b=Object.getPrototypeOf((A=p.hasOwnProperty)!=null?A:zs))!=null?b:zs))==null?void 0:F.toString))&&(y=p+"",i.push({start:m.length+d.length,length:y.length,error:`Value of type ${Object.prototype.toString.call(p).slice(8,-1)} is not a valid path parameter`})),m+d+(g===r.length?"":y)},""),l=a.split(/[?#]/,1)[0],u=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi,c;for(;(c=u.exec(l))!==null;)i.push({start:c.index,length:c[0].length,error:`Value "${c[0]}" can't be safely passed as a path parameter`});if(i.sort((m,d)=>m.start-d.start),i.length>0){let m=0,d=i.reduce((g,p)=>{let y=" ".repeat(p.start-m),A="^".repeat(p.length);return m=p.start+p.length,g+y+A},"");throw new w(`Path parameters result in path with invalid segments:
${i.map(g=>g.error).join(`
`)}
${a}
${d}`)}return a},f=si(Zs);var Be=class extends h{list(e,t={},r){return this._client.getAPIList(f`/chat/completions/${e}/messages`,E,{query:t,...r})}};function er(s){return s!==void 0&&"function"in s&&s.function!==void 0}function tr(s){return(s==null?void 0:s.$brand)==="auto-parseable-response-format"}function Ue(s){return(s==null?void 0:s.$brand)==="auto-parseable-tool"}function en(s,e){return!e||!cs(e)?{...s,choices:s.choices.map(t=>(rn(t.message.tool_calls),{...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:rr(s,e)}function rr(s,e){let t=s.choices.map(r=>{var n,i;if(r.finish_reason==="length")throw new dt;if(r.finish_reason==="content_filter")throw new ht;return rn(r.message.tool_calls),{...r,message:{...r.message,...r.message.tool_calls?{tool_calls:(i=(n=r.message.tool_calls)==null?void 0:n.map(a=>oi(e,a)))!=null?i:void 0}:void 0,parsed:r.message.content&&!r.message.refusal?ai(e,r.message.content):null}}});return{...s,choices:t}}function ai(s,e){var t,r;return((t=s.response_format)==null?void 0:t.type)!=="json_schema"?null:((r=s.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in s.response_format?s.response_format.$parseRaw(e):JSON.parse(e):null}function oi(s,e){var r;let t=(r=s.tools)==null?void 0:r.find(n=>{var i;return er(n)&&((i=n.function)==null?void 0:i.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:Ue(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function tn(s,e){var r;if(!s||!("tools"in s)||!s.tools)return!1;let t=(r=s.tools)==null?void 0:r.find(n=>{var i;return er(n)&&((i=n.function)==null?void 0:i.name)===e.function.name});return er(t)&&(Ue(t)||(t==null?void 0:t.function.strict)||!1)}function cs(s){var e,t;return tr(s.response_format)?!0:(t=(e=s.tools)==null?void 0:e.some(r=>Ue(r)||r.type==="function"&&r.function.strict===!0))!=null?t:!1}function rn(s){for(let e of s||[])if(e.type!=="function")throw new w(`Currently only \`function\` tool calls are supported; Received \`${e.type}\``)}function sn(s){for(let e of s!=null?s:[]){if(e.type!=="function")throw new w(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new w(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var gt=s=>(s==null?void 0:s.role)==="assistant",us=s=>(s==null?void 0:s.role)==="tool";var fs,Pr,Sr,sr,nr,Er,ir,me,ar,Rr,Cr,_t,nn,Ae=class{constructor(){fs.add(this),this.controller=new AbortController,Pr.set(this,void 0),Sr.set(this,()=>{}),sr.set(this,()=>{}),nr.set(this,void 0),Er.set(this,()=>{}),ir.set(this,()=>{}),me.set(this,{}),ar.set(this,!1),Rr.set(this,!1),Cr.set(this,!1),_t.set(this,!1),x(this,Pr,new Promise((e,t)=>{x(this,Sr,e,"f"),x(this,sr,t,"f")}),"f"),x(this,nr,new Promise((e,t)=>{x(this,Er,e,"f"),x(this,ir,t,"f")}),"f"),o(this,Pr,"f").catch(()=>{}),o(this,nr,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},o(this,fs,"m",nn).bind(this))},0)}_connected(){this.ended||(o(this,Sr,"f").call(this),this._emit("connect"))}get ended(){return o(this,ar,"f")}get errored(){return o(this,Rr,"f")}get aborted(){return o(this,Cr,"f")}abort(){this.controller.abort()}on(e,t){return(o(this,me,"f")[e]||(o(this,me,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=o(this,me,"f")[e];if(!r)return this;let n=r.findIndex(i=>i.listener===t);return n>=0&&r.splice(n,1),this}once(e,t){return(o(this,me,"f")[e]||(o(this,me,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{x(this,_t,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){x(this,_t,!0,"f"),await o(this,nr,"f")}_emit(e,...t){if(o(this,ar,"f"))return;e==="end"&&(x(this,ar,!0,"f"),o(this,Er,"f").call(this));let r=o(this,me,"f")[e];if(r&&(o(this,me,"f")[e]=r.filter(n=>!n.once),r.forEach(({listener:n})=>n(...t))),e==="abort"){let n=t[0];!o(this,_t,"f")&&!(r!=null&&r.length)&&Promise.reject(n),o(this,sr,"f").call(this,n),o(this,ir,"f").call(this,n),this._emit("end");return}if(e==="error"){let n=t[0];!o(this,_t,"f")&&!(r!=null&&r.length)&&Promise.reject(n),o(this,sr,"f").call(this,n),o(this,ir,"f").call(this,n),this._emit("end")}}_emitFinal(){}};Pr=new WeakMap,Sr=new WeakMap,sr=new WeakMap,nr=new WeakMap,Er=new WeakMap,ir=new WeakMap,me=new WeakMap,ar=new WeakMap,Rr=new WeakMap,Cr=new WeakMap,_t=new WeakMap,fs=new WeakSet,nn=function(e){if(x(this,Rr,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new j),e instanceof j)return x(this,Cr,!0,"f"),this._emit("abort",e);if(e instanceof w)return this._emit("error",e);if(e instanceof Error){let t=new w(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new w(String(e)))};function an(s){return typeof s.parse=="function"}var K,ds,vr,hs,ms,ps,on,ln,li=10,wt=class extends Ae{constructor(){super(...arguments),K.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),us(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(gt(e)&&e.tool_calls)for(let r of e.tool_calls)r.type==="function"&&this._emit("functionToolCall",r.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new w("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),o(this,K,"m",ds).call(this)}async finalMessage(){return await this.done(),o(this,K,"m",vr).call(this)}async finalFunctionToolCall(){return await this.done(),o(this,K,"m",hs).call(this)}async finalFunctionToolCallResult(){return await this.done(),o(this,K,"m",ms).call(this)}async totalUsage(){return await this.done(),o(this,K,"m",ps).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=o(this,K,"m",vr).call(this);t&&this._emit("finalMessage",t);let r=o(this,K,"m",ds).call(this);r&&this._emit("finalContent",r);let n=o(this,K,"m",hs).call(this);n&&this._emit("finalFunctionToolCall",n);let i=o(this,K,"m",ms).call(this);i!=null&&this._emit("finalFunctionToolCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",o(this,K,"m",ps).call(this))}async _createChatCompletion(e,t,r){let n=r==null?void 0:r.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),o(this,K,"m",on).call(this,t);let i=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(rr(i,t))}async _runChatCompletion(e,t,r){for(let n of t.messages)this._addMessage(n,!1);return await this._createChatCompletion(e,t,r)}async _runTools(e,t,r){var p,y,A;let n="tool",{tool_choice:i="auto",stream:a,...l}=t,u=typeof i!="string"&&i.type==="function"&&((p=i==null?void 0:i.function)==null?void 0:p.name),{maxChatCompletions:c=li}=r||{},m=t.tools.map(b=>{if(Ue(b)){if(!b.$callback)throw new w("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:b.$callback,name:b.function.name,description:b.function.description||"",parameters:b.function.parameters,parse:b.$parseRaw,strict:!0}}}return b}),d={};for(let b of m)b.type==="function"&&(d[b.function.name||b.function.function.name]=b.function);let g="tools"in t?m.map(b=>b.type==="function"?{type:"function",function:{name:b.function.name||b.function.function.name,parameters:b.function.parameters,description:b.function.description,strict:b.function.strict}}:b):void 0;for(let b of t.messages)this._addMessage(b,!1);for(let b=0;b<c;++b){let P=(y=(await this._createChatCompletion(e,{...l,tool_choice:i,tools:g,messages:[...this.messages]},r)).choices[0])==null?void 0:y.message;if(!P)throw new w("missing message in ChatCompletion response");if(!((A=P.tool_calls)!=null&&A.length))return;for(let M of P.tool_calls){if(M.type!=="function")continue;let $=M.id,{name:I,arguments:U}=M.function,T=d[I];if(T){if(u&&u!==I){let N=`Invalid tool_call: ${JSON.stringify(I)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:n,tool_call_id:$,content:N});continue}}else{let N=`Invalid tool_call: ${JSON.stringify(I)}. Available options are: ${Object.keys(d).map(k=>JSON.stringify(k)).join(", ")}. Please try again`;this._addMessage({role:n,tool_call_id:$,content:N});continue}let v;try{v=an(T)?await T.parse(U):U}catch(N){let k=N instanceof Error?N.message:String(N);this._addMessage({role:n,tool_call_id:$,content:k});continue}let C=await T.function(v,this),R=o(this,K,"m",ln).call(this,C);if(this._addMessage({role:n,tool_call_id:$,content:R}),u)return}}}};K=new WeakSet,ds=function(){var e;return(e=o(this,K,"m",vr).call(this).content)!=null?e:null},vr=function(){var t,r;let e=this.messages.length;for(;e-- >0;){let n=this.messages[e];if(gt(n))return{...n,content:(t=n.content)!=null?t:null,refusal:(r=n.refusal)!=null?r:null}}throw new w("stream ended without producing a ChatCompletionMessage with role=assistant")},hs=function(){var e,t;for(let r=this.messages.length-1;r>=0;r--){let n=this.messages[r];if(gt(n)&&((e=n==null?void 0:n.tool_calls)!=null&&e.length))return(t=n.tool_calls.filter(i=>i.type==="function").at(-1))==null?void 0:t.function}},ms=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(us(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(r=>{var n;return r.role==="assistant"&&((n=r.tool_calls)==null?void 0:n.some(i=>i.type==="function"&&i.id===t.tool_call_id))}))return t.content}},ps=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},on=function(e){if(e.n!=null&&e.n>1)throw new w("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ln=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var je=class extends wt{static runTools(e,t,r){let n=new je,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,i)),n}_addMessage(e,t=!0){super._addMessage(e,t),gt(e)&&e.content&&this._emit("content",e.content)}};var q={STR:1,NUM:2,ARR:4,OBJ:8,NULL:16,BOOL:32,NAN:64,INFINITY:128,MINUS_INFINITY:256,INF:384,SPECIAL:496,ATOM:499,COLLECTION:12,ALL:511},gs=class extends Error{},_s=class extends Error{};function ci(s,e=q.ALL){if(typeof s!="string")throw new TypeError(`expecting str, got ${typeof s}`);if(!s.trim())throw new Error(`${s} is empty`);return ui(s.trim(),e)}var ui=(s,e)=>{let t=s.length,r=0,n=g=>{throw new gs(`${g} at position ${r}`)},i=g=>{throw new _s(`${g} at position ${r}`)},a=()=>(d(),r>=t&&n("Unexpected end of input"),s[r]==='"'?l():s[r]==="{"?u():s[r]==="["?c():s.substring(r,r+4)==="null"||q.NULL&e&&t-r<4&&"null".startsWith(s.substring(r))?(r+=4,null):s.substring(r,r+4)==="true"||q.BOOL&e&&t-r<4&&"true".startsWith(s.substring(r))?(r+=4,!0):s.substring(r,r+5)==="false"||q.BOOL&e&&t-r<5&&"false".startsWith(s.substring(r))?(r+=5,!1):s.substring(r,r+8)==="Infinity"||q.INFINITY&e&&t-r<8&&"Infinity".startsWith(s.substring(r))?(r+=8,1/0):s.substring(r,r+9)==="-Infinity"||q.MINUS_INFINITY&e&&1<t-r&&t-r<9&&"-Infinity".startsWith(s.substring(r))?(r+=9,-1/0):s.substring(r,r+3)==="NaN"||q.NAN&e&&t-r<3&&"NaN".startsWith(s.substring(r))?(r+=3,NaN):m()),l=()=>{let g=r,p=!1;for(r++;r<t&&(s[r]!=='"'||p&&s[r-1]==="\\");)p=s[r]==="\\"?!p:!1,r++;if(s.charAt(r)=='"')try{return JSON.parse(s.substring(g,++r-Number(p)))}catch(y){i(String(y))}else if(q.STR&e)try{return JSON.parse(s.substring(g,r-Number(p))+'"')}catch(y){return JSON.parse(s.substring(g,s.lastIndexOf("\\"))+'"')}n("Unterminated string literal")},u=()=>{r++,d();let g={};try{for(;s[r]!=="}";){if(d(),r>=t&&q.OBJ&e)return g;let p=l();d(),r++;try{let y=a();Object.defineProperty(g,p,{value:y,writable:!0,enumerable:!0,configurable:!0})}catch(y){if(q.OBJ&e)return g;throw y}d(),s[r]===","&&r++}}catch(p){if(q.OBJ&e)return g;n("Expected '}' at end of object")}return r++,g},c=()=>{r++;let g=[];try{for(;s[r]!=="]";)g.push(a()),d(),s[r]===","&&r++}catch(p){if(q.ARR&e)return g;n("Expected ']' at end of array")}return r++,g},m=()=>{if(r===0){s==="-"&&q.NUM&e&&n("Not sure what '-' is");try{return JSON.parse(s)}catch(p){if(q.NUM&e)try{return s[s.length-1]==="."?JSON.parse(s.substring(0,s.lastIndexOf("."))):JSON.parse(s.substring(0,s.lastIndexOf("e")))}catch(y){}i(String(p))}}let g=r;for(s[r]==="-"&&r++;s[r]&&!",]}".includes(s[r]);)r++;r==t&&!(q.NUM&e)&&n("Unterminated number literal");try{return JSON.parse(s.substring(g,r))}catch(p){s.substring(g,r)==="-"&&q.NUM&e&&n("Not sure what '-' is");try{return JSON.parse(s.substring(g,s.lastIndexOf("e")))}catch(y){i(String(y))}}},d=()=>{for(;r<t&&` 
\r	`.includes(s[r]);)r++};return a()},ws=s=>ci(s,q.ALL^q.NUM);var D,pe,yt,Ie,ys,Or,bs,xs,As,$r,Is,cn,oe=class extends wt{constructor(e){super(),D.add(this),pe.set(this,void 0),yt.set(this,void 0),Ie.set(this,void 0),x(this,pe,e,"f"),x(this,yt,[],"f")}get currentChatCompletionSnapshot(){return o(this,Ie,"f")}static fromReadableStream(e){let t=new oe(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){let n=new oe(t);return n._run(()=>n._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createChatCompletion(e,t,r){var a;super._createChatCompletion;let n=r==null?void 0:r.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),o(this,D,"m",ys).call(this);let i=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(let l of i)o(this,D,"m",bs).call(this,l);if((a=i.controller.signal)!=null&&a.aborted)throw new j;return this._addChatCompletion(o(this,D,"m",$r).call(this))}async _fromReadableStream(e,t){var a;let r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),o(this,D,"m",ys).call(this),this._connected();let n=X.fromReadableStream(e,this.controller),i;for await(let l of n)i&&i!==l.id&&this._addChatCompletion(o(this,D,"m",$r).call(this)),o(this,D,"m",bs).call(this,l),i=l.id;if((a=n.controller.signal)!=null&&a.aborted)throw new j;return this._addChatCompletion(o(this,D,"m",$r).call(this))}[(pe=new WeakMap,yt=new WeakMap,Ie=new WeakMap,D=new WeakSet,ys=function(){this.ended||x(this,Ie,void 0,"f")},Or=function(t){let r=o(this,yt,"f")[t.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},o(this,yt,"f")[t.index]=r,r)},bs=function(t){var n,i,a,l,u,c,m,d,g,p,y,A,b,F,P,M,$,I,U,T;if(this.ended)return;let r=o(this,D,"m",cn).call(this,t);this._emit("chunk",t,r);for(let v of t.choices){let C=r.choices[v.index];v.delta.content!=null&&((n=C.message)==null?void 0:n.role)==="assistant"&&((i=C.message)!=null&&i.content)&&(this._emit("content",v.delta.content,C.message.content),this._emit("content.delta",{delta:v.delta.content,snapshot:C.message.content,parsed:C.message.parsed})),v.delta.refusal!=null&&((a=C.message)==null?void 0:a.role)==="assistant"&&((l=C.message)!=null&&l.refusal)&&this._emit("refusal.delta",{delta:v.delta.refusal,snapshot:C.message.refusal}),((u=v.logprobs)==null?void 0:u.content)!=null&&((c=C.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(m=v.logprobs)==null?void 0:m.content,snapshot:(g=(d=C.logprobs)==null?void 0:d.content)!=null?g:[]}),((p=v.logprobs)==null?void 0:p.refusal)!=null&&((y=C.message)==null?void 0:y.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(A=v.logprobs)==null?void 0:A.refusal,snapshot:(F=(b=C.logprobs)==null?void 0:b.refusal)!=null?F:[]});let R=o(this,D,"m",Or).call(this,C);C.finish_reason&&(o(this,D,"m",As).call(this,C),R.current_tool_call_index!=null&&o(this,D,"m",xs).call(this,C,R.current_tool_call_index));for(let N of(P=v.delta.tool_calls)!=null?P:[])R.current_tool_call_index!==N.index&&(o(this,D,"m",As).call(this,C),R.current_tool_call_index!=null&&o(this,D,"m",xs).call(this,C,R.current_tool_call_index)),R.current_tool_call_index=N.index;for(let N of(M=v.delta.tool_calls)!=null?M:[]){let k=($=C.message.tool_calls)==null?void 0:$[N.index];k!=null&&k.type&&((k==null?void 0:k.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(I=k.function)==null?void 0:I.name,index:N.index,arguments:k.function.arguments,parsed_arguments:k.function.parsed_arguments,arguments_delta:(T=(U=N.function)==null?void 0:U.arguments)!=null?T:""}):(k==null||k.type,void 0))}}},xs=function(t,r){var a,l,u;if(o(this,D,"m",Or).call(this,t).done_tool_calls.has(r))return;let i=(a=t.message.tool_calls)==null?void 0:a[r];if(!i)throw new Error("no tool call snapshot");if(!i.type)throw new Error("tool call snapshot missing `type`");if(i.type==="function"){let c=(u=(l=o(this,pe,"f"))==null?void 0:l.tools)==null?void 0:u.find(m=>er(m)&&m.function.name===i.function.name);this._emit("tool_calls.function.arguments.done",{name:i.function.name,index:r,arguments:i.function.arguments,parsed_arguments:Ue(c)?c.$parseRaw(i.function.arguments):c!=null&&c.function.strict?JSON.parse(i.function.arguments):null})}else i.type},As=function(t){var n,i;let r=o(this,D,"m",Or).call(this,t);if(t.message.content&&!r.content_done){r.content_done=!0;let a=o(this,D,"m",Is).call(this);this._emit("content.done",{content:t.message.content,parsed:a?a.$parseRaw(t.message.content):null})}t.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),(n=t.logprobs)!=null&&n.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),(i=t.logprobs)!=null&&i.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},$r=function(){if(this.ended)throw new w("stream has ended, this shouldn't happen");let t=o(this,Ie,"f");if(!t)throw new w("request ended without sending any chunks");return x(this,Ie,void 0,"f"),x(this,yt,[],"f"),fi(t,o(this,pe,"f"))},Is=function(){var r;let t=(r=o(this,pe,"f"))==null?void 0:r.response_format;return tr(t)?t:null},cn=function(t){var m,d,g,p,y,A;var r,n,i,a;let l=o(this,Ie,"f"),{choices:u,...c}=t;l?Object.assign(l,c):l=x(this,Ie,{...c,choices:[]},"f");for(let{delta:b,finish_reason:F,index:P,logprobs:M=null,...$}of t.choices){let I=l.choices[P];if(I||(I=l.choices[P]={finish_reason:F,index:P,message:{},logprobs:M,...$}),M)if(!I.logprobs)I.logprobs=Object.assign({},M);else{let{content:k,refusal:Z,...fe}=M;Object.assign(I.logprobs,fe),k&&((m=(r=I.logprobs).content)!=null||(r.content=[]),I.logprobs.content.push(...k)),Z&&((d=(n=I.logprobs).refusal)!=null||(n.refusal=[]),I.logprobs.refusal.push(...Z))}if(F&&(I.finish_reason=F,o(this,pe,"f")&&cs(o(this,pe,"f")))){if(F==="length")throw new dt;if(F==="content_filter")throw new ht}if(Object.assign(I,$),!b)continue;let{content:U,refusal:T,function_call:v,role:C,tool_calls:R,...N}=b;if(Object.assign(I.message,N),T&&(I.message.refusal=(I.message.refusal||"")+T),C&&(I.message.role=C),v&&(I.message.function_call?(v.name&&(I.message.function_call.name=v.name),v.arguments&&((g=(i=I.message.function_call).arguments)!=null||(i.arguments=""),I.message.function_call.arguments+=v.arguments)):I.message.function_call=v),U&&(I.message.content=(I.message.content||"")+U,!I.message.refusal&&o(this,D,"m",Is).call(this)&&(I.message.parsed=ws(I.message.content))),R){I.message.tool_calls||(I.message.tool_calls=[]);for(let{index:k,id:Z,type:fe,function:V,...Rn}of R){let re=(p=(a=I.message.tool_calls)[k])!=null?p:a[k]={};Object.assign(re,Rn),Z&&(re.id=Z),fe&&(re.type=fe),V&&((A=re.function)!=null||(re.function={name:(y=V.name)!=null?y:"",arguments:""})),V!=null&&V.name&&(re.function.name=V.name),V!=null&&V.arguments&&(re.function.arguments+=V.arguments,tn(o(this,pe,"f"),re)&&(re.function.parsed_arguments=ws(re.function.arguments)))}}}return l},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("chunk",n=>{let i=t.shift();i?i.resolve(n):e.push(n)}),this.on("end",()=>{r=!0;for(let n of t)n.resolve(void 0);t.length=0}),this.on("abort",n=>{r=!0;for(let i of t)i.reject(n);t.length=0}),this.on("error",n=>{r=!0;for(let i of t)i.reject(n);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new X(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function fi(s,e){let{id:t,choices:r,created:n,model:i,system_fingerprint:a,...l}=s,u={...l,id:t,choices:r.map(({message:c,finish_reason:m,index:d,logprobs:g,...p})=>{var M,$,I;if(!m)throw new w(`missing finish_reason for choice ${d}`);let{content:y=null,function_call:A,tool_calls:b,...F}=c,P=c.role;if(!P)throw new w(`missing role for choice ${d}`);if(A){let{arguments:U,name:T}=A;if(U==null)throw new w(`missing function_call.arguments for choice ${d}`);if(!T)throw new w(`missing function_call.name for choice ${d}`);return{...p,message:{content:y,function_call:{arguments:U,name:T},role:P,refusal:(M=c.refusal)!=null?M:null},finish_reason:m,index:d,logprobs:g}}return b?{...p,index:d,finish_reason:m,logprobs:g,message:{...F,role:P,content:y,refusal:($=c.refusal)!=null?$:null,tool_calls:b.map((U,T)=>{let{function:v,type:C,id:R,...N}=U,{arguments:k,name:Z,...fe}=v||{};if(R==null)throw new w(`missing choices[${d}].tool_calls[${T}].id
${kr(s)}`);if(C==null)throw new w(`missing choices[${d}].tool_calls[${T}].type
${kr(s)}`);if(Z==null)throw new w(`missing choices[${d}].tool_calls[${T}].function.name
${kr(s)}`);if(k==null)throw new w(`missing choices[${d}].tool_calls[${T}].function.arguments
${kr(s)}`);return{...N,id:R,type:C,function:{...fe,name:Z,arguments:k}}})}}:{...p,message:{...F,content:y,role:P,refusal:(I=c.refusal)!=null?I:null},finish_reason:m,index:d,logprobs:g}}),created:n,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return en(u,e)}function kr(s){return JSON.stringify(s)}var Pe=class extends oe{static fromReadableStream(e){let t=new Pe(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,r){let n=new Pe(t),i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,i)),n}};var ge=class extends h{constructor(){super(...arguments),this.messages=new Be(this._client)}create(e,t){var r;return this._client.post("/chat/completions",{body:e,...t,stream:(r=e.stream)!=null?r:!1})}retrieve(e,t){return this._client.get(f`/chat/completions/${e}`,t)}update(e,t,r){return this._client.post(f`/chat/completions/${e}`,{body:t,...r})}list(e={},t){return this._client.getAPIList("/chat/completions",E,{query:e,...t})}delete(e,t){return this._client.delete(f`/chat/completions/${e}`,t)}parse(e,t){return sn(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t==null?void 0:t.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(r=>rr(r,e))}runTools(e,t){return e.stream?Pe.runTools(this._client,e,t):je.runTools(this._client,e,t)}stream(e,t){return oe.createChatCompletion(this._client,e,t)}};ge.Messages=Be;var Se=class extends h{constructor(){super(...arguments),this.completions=new ge(this._client)}};Se.Completions=ge;var un=Symbol("brand.privateNullableHeaders");function*hi(s){if(!s)return;if(un in s){let{values:r,nulls:n}=s;yield*r.entries();for(let i of n)yield[i,null];return}let e=!1,t;s instanceof Headers?t=s.entries():Jr(s)?t=s:(e=!0,t=Object.entries(s!=null?s:{}));for(let r of t){let n=r[0];if(typeof n!="string")throw new TypeError("expected header name to be a string");let i=Jr(r[1])?r[1]:[r[1]],a=!1;for(let l of i)l!==void 0&&(e&&!a&&(a=!0,yield[n,null]),yield[n,l])}}var _=s=>{let e=new Headers,t=new Set;for(let r of s){let n=new Set;for(let[i,a]of hi(r)){let l=i.toLowerCase();n.has(l)||(e.delete(i),n.add(l)),a===null?(e.delete(i),t.add(l)):(e.append(i,a),t.delete(l))}}return{[un]:!0,values:e,nulls:t}};var bt=class extends h{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:_([{Accept:"application/octet-stream"},t==null?void 0:t.headers]),__binaryResponse:!0})}};var xt=class extends h{create(e,t){var r;return this._client.post("/audio/transcriptions",Y({body:e,...t,stream:(r=e.stream)!=null?r:!1,__metadata:{model:e.model}},this._client))}};var At=class extends h{create(e,t){return this._client.post("/audio/translations",Y({body:e,...t,__metadata:{model:e.model}},this._client))}};var le=class extends h{constructor(){super(...arguments),this.transcriptions=new xt(this._client),this.translations=new At(this._client),this.speech=new bt(this._client)}};le.Transcriptions=xt;le.Translations=At;le.Speech=bt;var We=class extends h{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(f`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",E,{query:e,...t})}cancel(e,t){return this._client.post(f`/batches/${e}/cancel`,t)}};var It=class extends h{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(f`/assistants/${e}`,{...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,r){return this._client.post(f`/assistants/${e}`,{body:t,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e={},t){return this._client.getAPIList("/assistants",E,{query:e,...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(e,t){return this._client.delete(f`/assistants/${e}`,{...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}};var Pt=class extends h{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}};var St=class extends h{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}};var Ee=class extends h{constructor(){super(...arguments),this.sessions=new Pt(this._client),this.transcriptionSessions=new St(this._client)}};Ee.Sessions=Pt;Ee.TranscriptionSessions=St;var Et=class extends h{create(e,t,r){return this._client.post(f`/threads/${e}/messages`,{body:t,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,t,r){let{thread_id:n}=t;return this._client.get(f`/threads/${n}/messages/${e}`,{...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,t,r){let{thread_id:n,...i}=t;return this._client.post(f`/threads/${n}/messages/${e}`,{body:i,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,t={},r){return this._client.getAPIList(f`/threads/${e}/messages`,E,{query:t,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,t,r){let{thread_id:n}=t;return this._client.delete(f`/threads/${n}/messages/${e}`,{...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}};var Rt=class extends h{retrieve(e,t,r){let{thread_id:n,run_id:i,...a}=t;return this._client.get(f`/threads/${n}/runs/${i}/steps/${e}`,{query:a,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,t,r){let{thread_id:n,...i}=t;return this._client.getAPIList(f`/threads/${n}/runs/${e}/steps`,E,{query:i,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}};var fn=s=>{if(typeof Buffer!="undefined"){let e=Buffer.from(s,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{let e=atob(s),t=e.length,r=new Uint8Array(t);for(let n=0;n<t;n++)r[n]=e.charCodeAt(n);return Array.from(new Float32Array(r.buffer))}};var Re=s=>{var e,t,r,n,i,a;if(typeof globalThis.process!="undefined")return(r=(t=(e=globalThis.process.env)==null?void 0:e[s])==null?void 0:t.trim())!=null?r:void 0;if(typeof globalThis.Deno!="undefined")return(a=(i=(n=globalThis.Deno.env)==null?void 0:n.get)==null?void 0:i.call(n,s))==null?void 0:a.trim()};var H,qe,Ps,ce,Tr,ee,He,Ct,De,Mr,z,Fr,Nr,cr,or,lr,dn,hn,mn,pn,gn,_n,wn,_e=class extends Ae{constructor(){super(...arguments),H.add(this),Ps.set(this,[]),ce.set(this,{}),Tr.set(this,{}),ee.set(this,void 0),He.set(this,void 0),Ct.set(this,void 0),De.set(this,void 0),Mr.set(this,void 0),z.set(this,void 0),Fr.set(this,void 0),Nr.set(this,void 0),cr.set(this,void 0)}[(Ps=new WeakMap,ce=new WeakMap,Tr=new WeakMap,ee=new WeakMap,He=new WeakMap,Ct=new WeakMap,De=new WeakMap,Mr=new WeakMap,z=new WeakMap,Fr=new WeakMap,Nr=new WeakMap,cr=new WeakMap,H=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",n=>{let i=t.shift();i?i.resolve(n):e.push(n)}),this.on("end",()=>{r=!0;for(let n of t)n.resolve(void 0);t.length=0}),this.on("abort",n=>{r=!0;for(let i of t)i.reject(n);t.length=0}),this.on("error",n=>{r=!0;for(let i of t)i.reject(n);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new qe;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var i;let r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();let n=X.fromReadableStream(e,this.controller);for await(let a of n)o(this,H,"m",or).call(this,a);if((i=n.controller.signal)!=null&&i.aborted)throw new j;return this._addRun(o(this,H,"m",lr).call(this))}toReadableStream(){return new X(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,n){let i=new qe;return i._run(()=>i._runToolAssistantStream(e,t,r,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,n){var u;let i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let a={...r,stream:!0},l=await e.submitToolOutputs(t,a,{...n,signal:this.controller.signal});this._connected();for await(let c of l)o(this,H,"m",or).call(this,c);if((u=l.controller.signal)!=null&&u.aborted)throw new j;return this._addRun(o(this,H,"m",lr).call(this))}static createThreadAssistantStream(e,t,r){let n=new qe;return n._run(()=>n._threadAssistantStream(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),n}static createAssistantStream(e,t,r,n){let i=new qe;return i._run(()=>i._runAssistantStream(e,t,r,{...n,headers:{...n==null?void 0:n.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return o(this,Fr,"f")}currentRun(){return o(this,Nr,"f")}currentMessageSnapshot(){return o(this,ee,"f")}currentRunStepSnapshot(){return o(this,cr,"f")}async finalRunSteps(){return await this.done(),Object.values(o(this,ce,"f"))}async finalMessages(){return await this.done(),Object.values(o(this,Tr,"f"))}async finalRun(){if(await this.done(),!o(this,He,"f"))throw Error("Final run was not received.");return o(this,He,"f")}async _createThreadAssistantStream(e,t,r){var l;let n=r==null?void 0:r.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort()));let i={...t,stream:!0},a=await e.createAndRun(i,{...r,signal:this.controller.signal});this._connected();for await(let u of a)o(this,H,"m",or).call(this,u);if((l=a.controller.signal)!=null&&l.aborted)throw new j;return this._addRun(o(this,H,"m",lr).call(this))}async _createAssistantStream(e,t,r,n){var u;let i=n==null?void 0:n.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let a={...r,stream:!0},l=await e.create(t,a,{...n,signal:this.controller.signal});this._connected();for await(let c of l)o(this,H,"m",or).call(this,c);if((u=l.controller.signal)!=null&&u.aborted)throw new j;return this._addRun(o(this,H,"m",lr).call(this))}static accumulateDelta(e,t){for(let[r,n]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=n;continue}let i=e[r];if(i==null){e[r]=n;continue}if(r==="index"||r==="type"){e[r]=n;continue}if(typeof i=="string"&&typeof n=="string")i+=n;else if(typeof i=="number"&&typeof n=="number")i+=n;else if(Kt(i)&&Kt(n))i=this.accumulateDelta(i,n);else if(Array.isArray(i)&&Array.isArray(n)){if(i.every(a=>typeof a=="string"||typeof a=="number")){i.push(...n);continue}for(let a of n){if(!Kt(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);let l=a.index;if(l==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof l!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${l}`);let u=i[l];u==null?i.push(a):i[l]=this.accumulateDelta(u,a)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${n}, accValue: ${i}`);e[r]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,n){return await this._createAssistantStream(t,e,r,n)}async _runToolAssistantStream(e,t,r,n){return await this._createToolAssistantStream(t,e,r,n)}};qe=_e,or=function(e){if(!this.ended)switch(x(this,Fr,e,"f"),o(this,H,"m",mn).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":o(this,H,"m",wn).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":o(this,H,"m",hn).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":o(this,H,"m",dn).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier");default:}},lr=function(){if(this.ended)throw new w("stream has ended, this shouldn't happen");if(!o(this,He,"f"))throw Error("Final run has not been received");return o(this,He,"f")},dn=function(e){let[t,r]=o(this,H,"m",gn).call(this,e,o(this,ee,"f"));x(this,ee,t,"f"),o(this,Tr,"f")[t.id]=t;for(let n of r){let i=t.content[n.index];(i==null?void 0:i.type)=="text"&&this._emit("textCreated",i.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let n of e.data.delta.content){if(n.type=="text"&&n.text){let i=n.text,a=t.content[n.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(n.index!=o(this,Ct,"f")){if(o(this,De,"f"))switch(o(this,De,"f").type){case"text":this._emit("textDone",o(this,De,"f").text,o(this,ee,"f"));break;case"image_file":this._emit("imageFileDone",o(this,De,"f").image_file,o(this,ee,"f"));break}x(this,Ct,n.index,"f")}x(this,De,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(o(this,Ct,"f")!==void 0){let n=e.data.content[o(this,Ct,"f")];if(n)switch(n.type){case"image_file":this._emit("imageFileDone",n.image_file,o(this,ee,"f"));break;case"text":this._emit("textDone",n.text,o(this,ee,"f"));break}}o(this,ee,"f")&&this._emit("messageDone",e.data),x(this,ee,void 0,"f")}},hn=function(e){let t=o(this,H,"m",pn).call(this,e);switch(x(this,cr,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let i of r.step_details.tool_calls)i.index==o(this,Mr,"f")?this._emit("toolCallDelta",i,t.step_details.tool_calls[i.index]):(o(this,z,"f")&&this._emit("toolCallDone",o(this,z,"f")),x(this,Mr,i.index,"f"),x(this,z,t.step_details.tool_calls[i.index],"f"),o(this,z,"f")&&this._emit("toolCallCreated",o(this,z,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":x(this,cr,void 0,"f"),e.data.step_details.type=="tool_calls"&&o(this,z,"f")&&(this._emit("toolCallDone",o(this,z,"f")),x(this,z,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},mn=function(e){o(this,Ps,"f").push(e),this._emit("event",e)},pn=function(e){switch(e.event){case"thread.run.step.created":return o(this,ce,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=o(this,ce,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){let n=qe.accumulateDelta(t,r.delta);o(this,ce,"f")[e.data.id]=n}return o(this,ce,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":o(this,ce,"f")[e.data.id]=e.data;break}if(o(this,ce,"f")[e.data.id])return o(this,ce,"f")[e.data.id];throw new Error("No snapshot available")},gn=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let n=e.data;if(n.delta.content)for(let i of n.delta.content)if(i.index in t.content){let a=t.content[i.index];t.content[i.index]=o(this,H,"m",_n).call(this,i,a)}else t.content[i.index]=i,r.push(i);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},_n=function(e,t){return qe.accumulateDelta(t,e)},wn=function(e){switch(x(this,Nr,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":x(this,He,e.data,"f"),o(this,z,"f")&&(this._emit("toolCallDone",o(this,z,"f")),x(this,z,void 0,"f"));break;case"thread.run.cancelling":break}};var Je=class extends h{constructor(){super(...arguments),this.steps=new Rt(this._client)}create(e,t,r){var a;let{include:n,...i}=t;return this._client.post(f`/threads/${e}/runs`,{query:{include:n},body:i,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers]),stream:(a=t.stream)!=null?a:!1})}retrieve(e,t,r){let{thread_id:n}=t;return this._client.get(f`/threads/${n}/runs/${e}`,{...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,t,r){let{thread_id:n,...i}=t;return this._client.post(f`/threads/${n}/runs/${e}`,{body:i,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,t={},r){return this._client.getAPIList(f`/threads/${e}/runs`,E,{query:t,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}cancel(e,t,r){let{thread_id:n}=t;return this._client.post(f`/threads/${n}/runs/${e}/cancel`,{...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async createAndPoll(e,t,r){let n=await this.create(e,t,r);return await this.poll(n.id,{thread_id:e},r)}createAndStream(e,t,r){return _e.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){var i,a;let n=_([r==null?void 0:r.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":(a=(i=r==null?void 0:r.pollIntervalMs)==null?void 0:i.toString())!=null?a:void 0}]);for(;;){let{data:l,response:u}=await this.retrieve(e,t,{...r,headers:{...r==null?void 0:r.headers,...n}}).withResponse();switch(l.status){case"queued":case"in_progress":case"cancelling":let c=5e3;if(r!=null&&r.pollIntervalMs)c=r.pollIntervalMs;else{let m=u.headers.get("openai-poll-after-ms");if(m){let d=parseInt(m);isNaN(d)||(c=d)}}await ne(c);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return l}}}stream(e,t,r){return _e.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r){var a;let{thread_id:n,...i}=t;return this._client.post(f`/threads/${n}/runs/${e}/submit_tool_outputs`,{body:i,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers]),stream:(a=t.stream)!=null?a:!1})}async submitToolOutputsAndPoll(e,t,r){let n=await this.submitToolOutputs(e,t,r);return await this.poll(n.id,t,r)}submitToolOutputsStream(e,t,r){return _e.createToolAssistantStream(e,this._client.beta.threads.runs,t,r)}};Je.Steps=Rt;var Ce=class extends h{constructor(){super(...arguments),this.runs=new Je(this._client),this.messages=new Et(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(f`/threads/${e}`,{...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,r){return this._client.post(f`/threads/${e}`,{body:t,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,t){return this._client.delete(f`/threads/${e}`,{...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}createAndRun(e,t){var r;return this._client.post("/threads/runs",{body:e,...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers]),stream:(r=e.stream)!=null?r:!1})}async createAndRunPoll(e,t){let r=await this.createAndRun(e,t);return await this.runs.poll(r.id,{thread_id:r.thread_id},t)}createAndRunStream(e,t){return _e.createThreadAssistantStream(e,this._client.beta.threads,t)}};Ce.Runs=Je;Ce.Messages=Et;var ue=class extends h{constructor(){super(...arguments),this.realtime=new Ee(this._client),this.assistants=new It(this._client),this.threads=new Ce(this._client)}};ue.Realtime=Ee;ue.Assistants=It;ue.Threads=Ce;var Xe=class extends h{create(e,t){var r;return this._client.post("/completions",{body:e,...t,stream:(r=e.stream)!=null?r:!1})}};var vt=class extends h{retrieve(e,t,r){let{container_id:n}=t;return this._client.get(f`/containers/${n}/files/${e}/content`,{...r,headers:_([{Accept:"application/binary"},r==null?void 0:r.headers]),__binaryResponse:!0})}};var Ke=class extends h{constructor(){super(...arguments),this.content=new vt(this._client)}create(e,t,r){return this._client.post(f`/containers/${e}/files`,Y({body:t,...r},this._client))}retrieve(e,t,r){let{container_id:n}=t;return this._client.get(f`/containers/${n}/files/${e}`,r)}list(e,t={},r){return this._client.getAPIList(f`/containers/${e}/files`,E,{query:t,...r})}delete(e,t,r){let{container_id:n}=t;return this._client.delete(f`/containers/${n}/files/${e}`,{...r,headers:_([{Accept:"*/*"},r==null?void 0:r.headers])})}};Ke.Content=vt;var ve=class extends h{constructor(){super(...arguments),this.files=new Ke(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(f`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",E,{query:e,...t})}delete(e,t){return this._client.delete(f`/containers/${e}`,{...t,headers:_([{Accept:"*/*"},t==null?void 0:t.headers])})}};ve.Files=Ke;var Ot=class extends h{create(e,t,r){let{include:n,...i}=t;return this._client.post(f`/conversations/${e}/items`,{query:{include:n},body:i,...r})}retrieve(e,t,r){let{conversation_id:n,...i}=t;return this._client.get(f`/conversations/${n}/items/${e}`,{query:i,...r})}list(e,t={},r){return this._client.getAPIList(f`/conversations/${e}/items`,Ar,{query:t,...r})}delete(e,t,r){let{conversation_id:n}=t;return this._client.delete(f`/conversations/${n}/items/${e}`,r)}};var Oe=class extends h{constructor(){super(...arguments),this.items=new Ot(this._client)}create(e,t){return this._client.post("/conversations",{body:e,...t})}retrieve(e,t){return this._client.get(f`/conversations/${e}`,t)}update(e,t,r){return this._client.post(f`/conversations/${e}`,{body:t,...r})}delete(e,t){return this._client.delete(f`/conversations/${e}`,t)}};Oe.Items=Ot;var Ve=class extends h{create(e,t){let r=!!e.encoding_format,n=r?e.encoding_format:"base64";r&&B(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);let i=this._client.post("/embeddings",{body:{...e,encoding_format:n},...t});return r?i:(B(this._client).debug("embeddings/decoding base64 embeddings from base64"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(l=>{let u=l.embedding;l.embedding=fn(u)}),a)))}};var $t=class extends h{retrieve(e,t,r){let{eval_id:n,run_id:i}=t;return this._client.get(f`/evals/${n}/runs/${i}/output_items/${e}`,r)}list(e,t,r){let{eval_id:n,...i}=t;return this._client.getAPIList(f`/evals/${n}/runs/${e}/output_items`,E,{query:i,...r})}};var Ge=class extends h{constructor(){super(...arguments),this.outputItems=new $t(this._client)}create(e,t,r){return this._client.post(f`/evals/${e}/runs`,{body:t,...r})}retrieve(e,t,r){let{eval_id:n}=t;return this._client.get(f`/evals/${n}/runs/${e}`,r)}list(e,t={},r){return this._client.getAPIList(f`/evals/${e}/runs`,E,{query:t,...r})}delete(e,t,r){let{eval_id:n}=t;return this._client.delete(f`/evals/${n}/runs/${e}`,r)}cancel(e,t,r){let{eval_id:n}=t;return this._client.post(f`/evals/${n}/runs/${e}`,r)}};Ge.OutputItems=$t;var $e=class extends h{constructor(){super(...arguments),this.runs=new Ge(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(f`/evals/${e}`,t)}update(e,t,r){return this._client.post(f`/evals/${e}`,{body:t,...r})}list(e={},t){return this._client.getAPIList("/evals",E,{query:e,...t})}delete(e,t){return this._client.delete(f`/evals/${e}`,t)}};$e.Runs=Ge;var Qe=class extends h{create(e,t){return this._client.post("/files",Y({body:e,...t},this._client))}retrieve(e,t){return this._client.get(f`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",E,{query:e,...t})}delete(e,t){return this._client.delete(f`/files/${e}`,t)}content(e,t){return this._client.get(f`/files/${e}/content`,{...t,headers:_([{Accept:"application/binary"},t==null?void 0:t.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){let n=new Set(["processed","error","deleted"]),i=Date.now(),a=await this.retrieve(e);for(;!a.status||!n.has(a.status);)if(await ne(t),a=await this.retrieve(e),Date.now()-i>r)throw new be({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return a}};var kt=class extends h{};var Tt=class extends h{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};var Ye=class extends h{constructor(){super(...arguments),this.graders=new Tt(this._client)}};Ye.Graders=Tt;var Ft=class extends h{create(e,t,r){return this._client.getAPIList(f`/fine_tuning/checkpoints/${e}/permissions`,ae,{body:t,method:"post",...r})}retrieve(e,t={},r){return this._client.get(f`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...r})}delete(e,t,r){let{fine_tuned_model_checkpoint:n}=t;return this._client.delete(f`/fine_tuning/checkpoints/${n}/permissions/${e}`,r)}};var ze=class extends h{constructor(){super(...arguments),this.permissions=new Ft(this._client)}};ze.Permissions=Ft;var Nt=class extends h{list(e,t={},r){return this._client.getAPIList(f`/fine_tuning/jobs/${e}/checkpoints`,E,{query:t,...r})}};var Ze=class extends h{constructor(){super(...arguments),this.checkpoints=new Nt(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(f`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",E,{query:e,...t})}cancel(e,t){return this._client.post(f`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return this._client.getAPIList(f`/fine_tuning/jobs/${e}/events`,E,{query:t,...r})}pause(e,t){return this._client.post(f`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(f`/fine_tuning/jobs/${e}/resume`,t)}};Ze.Checkpoints=Nt;var te=class extends h{constructor(){super(...arguments),this.methods=new kt(this._client),this.jobs=new Ze(this._client),this.checkpoints=new ze(this._client),this.alpha=new Ye(this._client)}};te.Methods=kt;te.Jobs=Ze;te.Checkpoints=ze;te.Alpha=Ye;var Mt=class extends h{};var ke=class extends h{constructor(){super(...arguments),this.graderModels=new Mt(this._client)}};ke.GraderModels=Mt;var et=class extends h{createVariation(e,t){return this._client.post("/images/variations",Y({body:e,...t},this._client))}edit(e,t){var r;return this._client.post("/images/edits",Y({body:e,...t,stream:(r=e.stream)!=null?r:!1},this._client))}generate(e,t){var r;return this._client.post("/images/generations",{body:e,...t,stream:(r=e.stream)!=null?r:!1})}};var tt=class extends h{retrieve(e,t){return this._client.get(f`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",ae,e)}delete(e,t){return this._client.delete(f`/models/${e}`,t)}};var rt=class extends h{create(e,t){return this._client.post("/moderations",{body:e,...t})}};var Lt=class extends h{create(e,t){return this._client.post("/realtime/client_secrets",{body:e,...t})}};var Te=class extends h{constructor(){super(...arguments),this.clientSecrets=new Lt(this._client)}};Te.ClientSecrets=Lt;function yn(s,e){return!e||!ji(e)?{...s,output_parsed:null,output:s.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(r=>({...r,parsed:null}))}:t)}:Ss(s,e)}function Ss(s,e){let t=s.output.map(n=>{if(n.type==="function_call")return{...n,parsed_arguments:qi(e,n)};if(n.type==="message"){let i=n.content.map(a=>a.type==="output_text"?{...a,parsed:Ui(e,a.text)}:a);return{...n,content:i}}return n}),r=Object.assign({},s,{output:t});return Object.getOwnPropertyDescriptor(s,"output_text")||Lr(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(let n of r.output)if(n.type==="message"){for(let i of n.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),r}function Ui(s,e){var t,r,n,i;return((r=(t=s.text)==null?void 0:t.format)==null?void 0:r.type)!=="json_schema"?null:"$parseRaw"in((n=s.text)==null?void 0:n.format)?((i=s.text)==null?void 0:i.format).$parseRaw(e):JSON.parse(e)}function ji(s){var e;return!!tr((e=s.text)==null?void 0:e.format)}function Wi(s){return(s==null?void 0:s.$brand)==="auto-parseable-tool"}function Di(s,e){return s.find(t=>t.type==="function"&&t.name===e)}function qi(s,e){var r;let t=Di((r=s.tools)!=null?r:[],e.name);return{...e,...e,parsed_arguments:Wi(t)?t.$parseRaw(e.arguments):t!=null&&t.strict?JSON.parse(e.arguments):null}}function Lr(s){let e=[];for(let t of s.output)if(t.type==="message")for(let r of t.content)r.type==="output_text"&&e.push(r.text);s.output_text=e.join("")}var Bt,Br,Fe,Ur,bn,xn,An,In,Ut=class extends Ae{constructor(e){super(),Bt.add(this),Br.set(this,void 0),Fe.set(this,void 0),Ur.set(this,void 0),x(this,Br,e,"f")}static createResponse(e,t,r){let n=new Ut(t);return n._run(()=>n._createOrRetrieveResponse(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createOrRetrieveResponse(e,t,r){var l,u;let n=r==null?void 0:r.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),o(this,Bt,"m",bn).call(this);let i,a=null;"response_id"in t?(i=await e.responses.retrieve(t.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),a=(l=t.starting_after)!=null?l:null):i=await e.responses.create({...t,stream:!0},{...r,signal:this.controller.signal}),this._connected();for await(let c of i)o(this,Bt,"m",xn).call(this,c,a);if((u=i.controller.signal)!=null&&u.aborted)throw new j;return o(this,Bt,"m",An).call(this)}[(Br=new WeakMap,Fe=new WeakMap,Ur=new WeakMap,Bt=new WeakSet,bn=function(){this.ended||x(this,Fe,void 0,"f")},xn=function(t,r){if(this.ended)return;let n=(a,l)=>{(r==null||l.sequence_number>r)&&this._emit(a,l)},i=o(this,Bt,"m",In).call(this,t);switch(n("event",t),t.type){case"response.output_text.delta":{let a=i.output[t.output_index];if(!a)throw new w(`missing output at index ${t.output_index}`);if(a.type==="message"){let l=a.content[t.content_index];if(!l)throw new w(`missing content at index ${t.content_index}`);if(l.type!=="output_text")throw new w(`expected content to be 'output_text', got ${l.type}`);n("response.output_text.delta",{...t,snapshot:l.text})}break}case"response.function_call_arguments.delta":{let a=i.output[t.output_index];if(!a)throw new w(`missing output at index ${t.output_index}`);a.type==="function_call"&&n("response.function_call_arguments.delta",{...t,snapshot:a.arguments});break}default:n(t.type,t);break}},An=function(){if(this.ended)throw new w("stream has ended, this shouldn't happen");let t=o(this,Fe,"f");if(!t)throw new w("request ended without sending any events");x(this,Fe,void 0,"f");let r=Hi(t,o(this,Br,"f"));return x(this,Ur,r,"f"),r},In=function(t){let r=o(this,Fe,"f");if(!r){if(t.type!=="response.created")throw new w(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return r=x(this,Fe,t.response,"f"),r}switch(t.type){case"response.output_item.added":{r.output.push(t.item);break}case"response.content_part.added":{let n=r.output[t.output_index];if(!n)throw new w(`missing output at index ${t.output_index}`);n.type==="message"&&n.content.push(t.part);break}case"response.output_text.delta":{let n=r.output[t.output_index];if(!n)throw new w(`missing output at index ${t.output_index}`);if(n.type==="message"){let i=n.content[t.content_index];if(!i)throw new w(`missing content at index ${t.content_index}`);if(i.type!=="output_text")throw new w(`expected content to be 'output_text', got ${i.type}`);i.text+=t.delta}break}case"response.function_call_arguments.delta":{let n=r.output[t.output_index];if(!n)throw new w(`missing output at index ${t.output_index}`);n.type==="function_call"&&(n.arguments+=t.delta);break}case"response.completed":{x(this,Fe,t.response,"f");break}}return r},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",n=>{let i=t.shift();i?i.resolve(n):e.push(n)}),this.on("end",()=>{r=!0;for(let n of t)n.resolve(void 0);t.length=0}),this.on("abort",n=>{r=!0;for(let i of t)i.reject(n);t.length=0}),this.on("error",n=>{r=!0;for(let i of t)i.reject(n);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();let e=o(this,Ur,"f");if(!e)throw new w("stream ended without producing a ChatCompletion");return e}};function Hi(s,e){return yn(s,e)}var jt=class extends h{list(e,t={},r){return this._client.getAPIList(f`/responses/${e}/input_items`,E,{query:t,...r})}};var Ne=class extends h{constructor(){super(...arguments),this.inputItems=new jt(this._client)}create(e,t){var r;return this._client.post("/responses",{body:e,...t,stream:(r=e.stream)!=null?r:!1})._thenUnwrap(n=>("object"in n&&n.object==="response"&&Lr(n),n))}retrieve(e,t={},r){var n;return this._client.get(f`/responses/${e}`,{query:t,...r,stream:(n=t==null?void 0:t.stream)!=null?n:!1})._thenUnwrap(i=>("object"in i&&i.object==="response"&&Lr(i),i))}delete(e,t){return this._client.delete(f`/responses/${e}`,{...t,headers:_([{Accept:"*/*"},t==null?void 0:t.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(r=>Ss(r,e))}stream(e,t){return Ut.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(f`/responses/${e}/cancel`,t)}};Ne.InputItems=jt;var Wt=class extends h{create(e,t,r){return this._client.post(f`/uploads/${e}/parts`,Y({body:t,...r},this._client))}};var Me=class extends h{constructor(){super(...arguments),this.parts=new Wt(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(f`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(f`/uploads/${e}/complete`,{body:t,...r})}};Me.Parts=Wt;var Pn=async s=>{let e=await Promise.allSettled(s),t=e.filter(n=>n.status==="rejected");if(t.length){for(let n of t)console.error(n.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}let r=[];for(let n of e)n.status==="fulfilled"&&r.push(n.value);return r};var Dt=class extends h{create(e,t,r){return this._client.post(f`/vector_stores/${e}/file_batches`,{body:t,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,t,r){let{vector_store_id:n}=t;return this._client.get(f`/vector_stores/${n}/file_batches/${e}`,{...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}cancel(e,t,r){let{vector_store_id:n}=t;return this._client.post(f`/vector_stores/${n}/file_batches/${e}/cancel`,{...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async createAndPoll(e,t,r){let n=await this.create(e,t);return await this.poll(e,n.id,r)}listFiles(e,t,r){let{vector_store_id:n,...i}=t;return this._client.getAPIList(f`/vector_stores/${n}/file_batches/${e}/files`,E,{query:i,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async poll(e,t,r){var i,a;let n=_([r==null?void 0:r.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":(a=(i=r==null?void 0:r.pollIntervalMs)==null?void 0:i.toString())!=null?a:void 0}]);for(;;){let{data:l,response:u}=await this.retrieve(t,{vector_store_id:e},{...r,headers:n}).withResponse();switch(l.status){case"in_progress":let c=5e3;if(r!=null&&r.pollIntervalMs)c=r.pollIntervalMs;else{let m=u.headers.get("openai-poll-after-ms");if(m){let d=parseInt(m);isNaN(d)||(c=d)}}await ne(c);break;case"failed":case"cancelled":case"completed":return l}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},n){var g;if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let i=(g=n==null?void 0:n.maxConcurrency)!=null?g:5,a=Math.min(i,t.length),l=this._client,u=t.values(),c=[...r];async function m(p){for(let y of p){let A=await l.files.create({file:y,purpose:"assistants"},n);c.push(A.id)}}let d=Array(a).fill(u).map(m);return await Pn(d),await this.createAndPoll(e,{file_ids:c})}};var qt=class extends h{create(e,t,r){return this._client.post(f`/vector_stores/${e}/files`,{body:t,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}retrieve(e,t,r){let{vector_store_id:n}=t;return this._client.get(f`/vector_stores/${n}/files/${e}`,{...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}update(e,t,r){let{vector_store_id:n,...i}=t;return this._client.post(f`/vector_stores/${n}/files/${e}`,{body:i,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e,t={},r){return this._client.getAPIList(f`/vector_stores/${e}/files`,E,{query:t,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}delete(e,t,r){let{vector_store_id:n}=t;return this._client.delete(f`/vector_stores/${n}/files/${e}`,{...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}async createAndPoll(e,t,r){let n=await this.create(e,t,r);return await this.poll(e,n.id,r)}async poll(e,t,r){var i,a;let n=_([r==null?void 0:r.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":(a=(i=r==null?void 0:r.pollIntervalMs)==null?void 0:i.toString())!=null?a:void 0}]);for(;;){let l=await this.retrieve(t,{vector_store_id:e},{...r,headers:n}).withResponse(),u=l.data;switch(u.status){case"in_progress":let c=5e3;if(r!=null&&r.pollIntervalMs)c=r.pollIntervalMs;else{let m=l.response.headers.get("openai-poll-after-ms");if(m){let d=parseInt(m);isNaN(d)||(c=d)}}await ne(c);break;case"failed":case"completed":return u}}}async upload(e,t,r){let n=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:n.id},r)}async uploadAndPoll(e,t,r){let n=await this.upload(e,t,r);return await this.poll(e,n.id,r)}content(e,t,r){let{vector_store_id:n}=t;return this._client.getAPIList(f`/vector_stores/${n}/files/${e}/content`,ae,{...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}};var we=class extends h{constructor(){super(...arguments),this.files=new qt(this._client),this.fileBatches=new Dt(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}retrieve(e,t){return this._client.get(f`/vector_stores/${e}`,{...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}update(e,t,r){return this._client.post(f`/vector_stores/${e}`,{body:t,...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",E,{query:e,...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}delete(e,t){return this._client.delete(f`/vector_stores/${e}`,{...t,headers:_([{"OpenAI-Beta":"assistants=v2"},t==null?void 0:t.headers])})}search(e,t,r){return this._client.getAPIList(f`/vector_stores/${e}/search`,ae,{body:t,method:"post",...r,headers:_([{"OpenAI-Beta":"assistants=v2"},r==null?void 0:r.headers])})}};we.Files=qt;we.FileBatches=Dt;var Ht,Sn,jr,st=class extends h{constructor(){super(...arguments),Ht.add(this)}async unwrap(e,t,r=this._client.webhookSecret,n=300){return await this.verifySignature(e,t,r,n),JSON.parse(e)}async verifySignature(e,t,r=this._client.webhookSecret,n=300){if(typeof crypto=="undefined"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");o(this,Ht,"m",Sn).call(this,r);let i=_([t]).values,a=o(this,Ht,"m",jr).call(this,i,"webhook-signature"),l=o(this,Ht,"m",jr).call(this,i,"webhook-timestamp"),u=o(this,Ht,"m",jr).call(this,i,"webhook-id"),c=parseInt(l,10);if(isNaN(c))throw new se("Invalid webhook timestamp format");let m=Math.floor(Date.now()/1e3);if(m-c>n)throw new se("Webhook timestamp is too old");if(c>m+n)throw new se("Webhook timestamp is too new");let d=a.split(" ").map(A=>A.startsWith("v1,")?A.substring(3):A),g=r.startsWith("whsec_")?Buffer.from(r.replace("whsec_",""),"base64"):Buffer.from(r,"utf-8"),p=u?`${u}.${l}.${e}`:`${l}.${e}`,y=await crypto.subtle.importKey("raw",g,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(let A of d)try{let b=Buffer.from(A,"base64");if(await crypto.subtle.verify("HMAC",y,b,new TextEncoder().encode(p)))return}catch(b){continue}throw new se("The given webhook signature does not match the expected signature")}};Ht=new WeakSet,Sn=function(e){if(typeof e!="string"||e.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},jr=function(e,t){if(!e)throw new Error("Headers are required");let r=e.get(t);if(r==null)throw new Error(`Missing required header: ${t}`);return r};var Es,Rs,Wr,En,S=class{constructor({baseURL:e=Re("OPENAI_BASE_URL"),apiKey:t=Re("OPENAI_API_KEY"),organization:r=(l=>(l=Re("OPENAI_ORG_ID"))!=null?l:null)(),project:n=(u=>(u=Re("OPENAI_PROJECT_ID"))!=null?u:null)(),webhookSecret:i=(c=>(c=Re("OPENAI_WEBHOOK_SECRET"))!=null?c:null)(),...a}={}){var g,p,y,A,b,F;if(Es.add(this),Wr.set(this,void 0),this.completions=new Xe(this),this.chat=new Se(this),this.embeddings=new Ve(this),this.files=new Qe(this),this.images=new et(this),this.audio=new le(this),this.moderations=new rt(this),this.models=new tt(this),this.fineTuning=new te(this),this.graders=new ke(this),this.vectorStores=new we(this),this.webhooks=new st(this),this.beta=new ue(this),this.batches=new We(this),this.uploads=new Me(this),this.responses=new Ne(this),this.realtime=new Te(this),this.conversations=new Oe(this),this.evals=new $e(this),this.containers=new ve(this),t===void 0)throw new w("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");let m={apiKey:t,organization:r,project:n,webhookSecret:i,...a,baseURL:e||"https://api.openai.com/v1"};if(!m.dangerouslyAllowBrowser&&Ls())throw new w(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=m.baseURL,this.timeout=(g=m.timeout)!=null?g:Rs.DEFAULT_TIMEOUT,this.logger=(p=m.logger)!=null?p:console;let d="warn";this.logLevel=d,this.logLevel=(A=(y=rs(m.logLevel,"ClientOptions.logLevel",this))!=null?y:rs(Re("OPENAI_LOG"),"process.env['OPENAI_LOG']",this))!=null?A:d,this.fetchOptions=m.fetchOptions,this.maxRetries=(b=m.maxRetries)!=null?b:2,this.fetch=(F=m.fetch)!=null?F:Us(),x(this,Wr,Ws,"f"),this._options=m,this.apiKey=typeof t=="string"?t:"Missing Key",this.organization=r,this.project=n,this.webhookSecret=i}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return _([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return es(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${xe}`}defaultIdempotencyKey(){return`stainless-node-retry-${Hr()}`}makeStatusError(e,t,r,n){return L.generate(e,t,r,n)}async _callApiKey(){let e=this._options.apiKey;if(typeof e!="function")return!1;let t;try{t=await e()}catch(r){throw r instanceof w?r:new w(`Failed to get token from 'apiKey' function: ${r.message}`,{cause:r})}if(typeof t!="string"||!t)throw new w(`Expected 'apiKey' function argument to return a string but it returned ${t}`);return this.apiKey=t,!0}buildURL(e,t,r){let n=!o(this,Es,"m",En).call(this)&&r||this.baseURL,i=Os(e)?new URL(e):new URL(n+(n.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return $s(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(i.search=this.stringifyQuery(t)),i.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:t,options:r}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(n=>({method:e,path:t,...n})))}request(e,t=null){return new he(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,r){var F,P,M;let n=await e,i=(F=n.maxRetries)!=null?F:this.maxRetries;t==null&&(t=i),await this.prepareOptions(n);let{req:a,url:l,timeout:u}=await this.buildRequest(n,{retryCount:i-t});await this.prepareRequest(a,{url:l,options:n});let c="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),m=r===void 0?"":`, retryOf: ${r}`,d=Date.now();if(B(this).debug(`[${c}] sending request`,de({retryOfRequestLogID:r,method:n.method,url:l,options:n,headers:a.headers})),(P=n.signal)!=null&&P.aborted)throw new j;let g=new AbortController,p=await this.fetchWithTimeout(l,a,u,g).catch(Xt),y=Date.now();if(p instanceof globalThis.Error){let $=`retrying, ${t} attempts remaining`;if((M=n.signal)!=null&&M.aborted)throw new j;let I=Jt(p)||/timed? ?out/i.test(String(p)+("cause"in p?String(p.cause):""));if(t)return B(this).info(`[${c}] connection ${I?"timed out":"failed"} - ${$}`),B(this).debug(`[${c}] connection ${I?"timed out":"failed"} (${$})`,de({retryOfRequestLogID:r,url:l,durationMs:y-d,message:p.message})),this.retryRequest(n,t,r!=null?r:c);throw B(this).info(`[${c}] connection ${I?"timed out":"failed"} - error; no more retries left`),B(this).debug(`[${c}] connection ${I?"timed out":"failed"} (error; no more retries left)`,de({retryOfRequestLogID:r,url:l,durationMs:y-d,message:p.message})),I?new be:new ye({cause:p})}let A=[...p.headers.entries()].filter(([$])=>$==="x-request-id").map(([$,I])=>", "+$+": "+JSON.stringify(I)).join(""),b=`[${c}${m}${A}] ${a.method} ${l} ${p.ok?"succeeded":"failed"} with status ${p.status} in ${y-d}ms`;if(!p.ok){let $=await this.shouldRetry(p);if(t&&$){let R=`retrying, ${t} attempts remaining`;return await js(p.body),B(this).info(`${b} - ${R}`),B(this).debug(`[${c}] response error (${R})`,de({retryOfRequestLogID:r,url:p.url,status:p.status,headers:p.headers,durationMs:y-d})),this.retryRequest(n,t,r!=null?r:c,p.headers)}let I=$?"error; no more retries left":"error; not retryable";B(this).info(`${b} - ${I}`);let U=await p.text().catch(R=>Xt(R).message),T=Fs(U),v=T?void 0:U;throw B(this).debug(`[${c}] response error (${I})`,de({retryOfRequestLogID:r,url:p.url,status:p.status,headers:p.headers,message:v,durationMs:Date.now()-d})),this.makeStatusError(p.status,T,v,p.headers)}return B(this).info(b),B(this).debug(`[${c}] response start`,de({retryOfRequestLogID:r,url:p.url,status:p.status,headers:p.headers,durationMs:y-d})),{response:p,options:n,controller:g,requestLogID:c,retryOfRequestLogID:r,startTime:d}}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}requestAPIList(e,t){let r=this.makeRequest(t,null,void 0);return new zt(this,r,e)}async fetchWithTimeout(e,t,r,n){let{signal:i,method:a,...l}=t||{};i&&i.addEventListener("abort",()=>n.abort());let u=setTimeout(()=>n.abort(),r),c=globalThis.ReadableStream&&l.body instanceof globalThis.ReadableStream||typeof l.body=="object"&&l.body!==null&&Symbol.asyncIterator in l.body,m={signal:n.signal,...c?{duplex:"half"}:{},method:"GET",...l};a&&(m.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,m)}finally{clearTimeout(u)}}async shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r,n){var u;let i,a=n==null?void 0:n.get("retry-after-ms");if(a){let c=parseFloat(a);Number.isNaN(c)||(i=c)}let l=n==null?void 0:n.get("retry-after");if(l&&!i){let c=parseFloat(l);Number.isNaN(c)?i=Date.parse(l)-Date.now():i=c*1e3}if(!(i&&0<=i&&i<60*1e3)){let c=(u=e.maxRetries)!=null?u:this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,c)}return await ne(i),this.makeRequest(e,t-1,r)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,a=Math.min(.5*Math.pow(2,i),8),l=1-Math.random()*.25;return a*l*1e3}async buildRequest(e,{retryCount:t=0}={}){var p,y,A;let r={...e},{method:n,path:i,query:a,defaultBaseURL:l}=r,u=this.buildURL(i,a,l);"timeout"in r&&Ts("timeout",r.timeout),r.timeout=(p=r.timeout)!=null?p:this.timeout;let{bodyHeaders:c,body:m}=this.buildBody({options:r}),d=await this.buildHeaders({options:e,method:n,bodyHeaders:c,retryCount:t});return{req:{method:n,headers:d,...r.signal&&{signal:r.signal},...globalThis.ReadableStream&&m instanceof globalThis.ReadableStream&&{duplex:"half"},...m&&{body:m},...(y=this.fetchOptions)!=null?y:{},...(A=r.fetchOptions)!=null?A:{}},url:u,timeout:r.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:r,retryCount:n}){let i={};this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let a=_([i,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(n),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...Bs(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,r,e.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let r=_([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&r.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:fr(e)}:o(this,Wr,"f").call(this,{body:e,headers:r})}};Rs=S,Wr=new WeakMap,Es=new WeakSet,En=function(){return this.baseURL!=="https://api.openai.com/v1"};S.OpenAI=Rs;S.DEFAULT_TIMEOUT=6e5;S.OpenAIError=w;S.APIError=L;S.APIConnectionError=ye;S.APIConnectionTimeoutError=be;S.APIUserAbortError=j;S.NotFoundError=ot;S.ConflictError=lt;S.RateLimitError=ut;S.BadRequestError=nt;S.AuthenticationError=it;S.InternalServerError=ft;S.PermissionDeniedError=at;S.UnprocessableEntityError=ct;S.InvalidWebhookSignatureError=se;S.toFile=Ir;S.Completions=Xe;S.Chat=Se;S.Embeddings=Ve;S.Files=Qe;S.Images=et;S.Audio=le;S.Moderations=rt;S.Models=tt;S.FineTuning=te;S.Graders=ke;S.VectorStores=we;S.Webhooks=st;S.Beta=ue;S.Batches=We;S.Uploads=Me;S.Responses=Ne;S.Realtime=Te;S.Conversations=Oe;S.Evals=$e;S.Containers=ve;var Qi={mySetting:"default",openaiApiKey:""},Dr=class extends O.Plugin{async onload(){console.log("loading Pic2Markdown plugin"),await this.loadSettings();let t=this.addRibbonIcon("aperture","Convert Image(s) to Markdown",()=>{new Cs(this.app,this).open()});this.addSettingTab(new vs(this.app,this)),this.addCommand({id:"convert-images-in-active-note-and-prepend",name:"Convert Images in Active Note & Prepend Text",editorCallback:async(r,n)=>{if(!this.settings.openaiApiKey){new O.Notice("OpenAI API key is not set. Please configure it in the plugin settings.");return}let i=n.file;if(!i){new O.Notice("No active file.");return}new O.Notice("Processing images in current note...",5e3);let a=this.app.metadataCache.getFileCache(i),l=a==null?void 0:a.embeds;if(!l||l.length===0){new O.Notice("No embedded images found in the current note.");return}let u="",c=0;for(let m of l){let d=m.link,g=this.app.metadataCache.getFirstLinkpathDest(d,i.path);if(g instanceof O.TFile){let p=this.getMimeType(g.extension);if(p)try{new O.Notice(`Processing ${g.name}...`,3e3);let y=await this.app.vault.readBinary(g),A=this.arrayBufferToBase64(y,p),b=await this._callOpenAIWithImageData(A);u+=`## Image: ${g.name}

${b}

`,c++}catch(y){console.error(`Error processing image ${g.name}:`,y),new O.Notice(`Error processing ${g.name}: ${y.message}`)}}}if(c===0){new O.Notice("No processable images found or all image processing failed.");return}try{let m=await this.app.vault.read(i),d=u.trim()+`

`+m;await this.app.vault.modify(i,d),new O.Notice(`${c} image(s) processed and text prepended to the note.`)}catch(m){console.error("Error updating note content:",m),new O.Notice("Error updating note content.")}}})}onunload(){console.log("unloading Picture to Markdown plugin")}async loadSettings(){this.settings=Object.assign({},Qi,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async _callOpenAIWithImageData(t){if(!this.settings.openaiApiKey)throw new Error("OpenAI API key is not set. Please configure it in the plugin settings.");let r=new S({apiKey:this.settings.openaiApiKey,dangerouslyAllowBrowser:!0});try{return((await r.responses.create({model:"gpt-5",instructions:"You are an assistant that converts handwritten notes, including diagrams and sketches, into clear, audience-focused Markdown explanations. When processing images, do not just describe the diagram; instead, explain the concept as if to someone who has never seen the image, aiming to teach or introduce the underlying ideas and how the parts relate to each other. When appropriate, restructure the content into sentences and lists that would help someone understand and apply the concepts.",input:[{role:"user",content:[{type:"input_text",text:"Convert the content of this image into Markdown. Use tabs for nested lists. Do not include a 'markdown' header. Where diagrams or drawings appear, explain their concepts and key points in clear language, as if teaching someone who cannot see the image. Summarise relationships between parts (such as sections or categories in a chart), and use sentence structure that guides the reader in understanding the overall idea and how details fit together."},{type:"input_image",image_url:t,detail:"auto"}]}]})).output_text||"No content extracted.").replace(/```/g,"").trim()}catch(n){throw console.error("Error calling OpenAI:",n),n}}getMimeType(t){switch(t.toLowerCase()){case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"gif":return"image/gif";case"bmp":return"image/bmp";case"webp":return"image/webp";case"svg":return"image/svg+xml";default:return null}}arrayBufferToBase64(t,r){let n="",i=new Uint8Array(t),a=i.byteLength;for(let l=0;l<a;l++)n+=String.fromCharCode(i[l]);return`data:${r};base64,${window.btoa(n)}`}},Cs=class extends O.Modal{constructor(t,r){super(t);this.plugin=r}onOpen(){let{contentEl:t}=this;t.addClass("pic2markdown-modal"),t.createEl("h2",{text:"Upload your Image(s)"});let r=t.createEl("div",{cls:"mode-select-container"});r.createEl("label",{text:"Choose mode:"});let n=r.createEl("select");["Single Image","Multi Image","Bulk"].forEach(A=>{let b=n.createEl("option");b.value=A,b.text=A});let i=t.createDiv({cls:"file-name-container"});i.createEl("label",{text:"Name of the new file:"});let a=i.createEl("input",{type:"text"});a.value="Untitled";let l=()=>{n.value==="Bulk"?i.classList.add("hidden"):i.classList.remove("hidden")};l(),n.addEventListener("change",l);let u=t.createDiv({cls:"file-select-container"});u.createEl("label",{text:"Select image(s):"});let c=u.createDiv({cls:"custom-file-input"}),m=c.createEl("input",{cls:"pic2markdown-file-input"});m.type="file",m.accept="image/*",m.multiple=!0;let d=c.createEl("button",{text:"Choose Image(s)",cls:"styled-file-button"}),g=c.createEl("div",{cls:"file-names"});d.addEventListener("click",A=>{A.preventDefault(),m.click()}),m.addEventListener("change",()=>{if(m.files){let A=Array.from(m.files).map(b=>b.name);g.textContent=A.join(", ")}});let p=t.createDiv({cls:"pic2markdown-process-container"}),y=p.createEl("button",{text:"Send to GPT"});this.spinnerEl=p.createEl("div",{cls:"pic2markdown-spinner pic2markdown-spinner-hidden"}),y.addEventListener("click",async()=>{if(!m.files||m.files.length===0){new O.Notice("Please upload at least one image!");return}this.spinnerEl.classList.remove("pic2markdown-spinner-hidden"),this.spinnerEl.classList.add("pic2markdown-spinner-inline"),y.disabled=!0;try{let A=n.value;A==="Single Image"?await this.handleSingleImage(m,a.value.trim()):A==="Multi Image"?await this.handleMultiImage(m,a.value.trim()):await this.handleBulk(m),this.close()}catch(A){console.error(A),new O.Notice(A.message||"An error occurred processing the images.")}finally{this.spinnerEl.classList.remove("pic2markdown-spinner-inline"),this.spinnerEl.classList.add("pic2markdown-spinner-hidden"),y.disabled=!1}})}onClose(){let{contentEl:t}=this;t.empty()}async handleSingleImage(t,r){if(!r){new O.Notice("Please enter a valid file name.");return}let n=t.files[0],i=await this.processImage(n);await this.createNewNoteWithContent(i,r),new O.Notice(`Note "${r}" created successfully (Single Image).`)}async handleMultiImage(t,r){if(!r){new O.Notice("Please enter a valid file name.");return}let n="";for(let i=0;i<t.files.length;i++){let a=t.files[i];new O.Notice(`Processing image #${i+1}: ${a.name}`);let l=await this.processImage(a);n+=`## Image #${i+1} - ${a.name}

`,n+=l+`

`}await this.createNewNoteWithContent(n,r),new O.Notice(`Note "${r}" created successfully (Multi Image).`)}async handleBulk(t){var r;for(let n=0;n<t.files.length;n++){let i=t.files[n];new O.Notice(`Processing image #${n+1}: ${i.name}`);let a=await this.processImage(i),u=((r=a.trim().split(`
`)[0])==null?void 0:r.trim())||"";u||(u=`Image_${n+1}`),u=u.replace(/[<>:"/\\|?*]/g,""),await this.createNewNoteWithContent(a,u),new O.Notice(`Created note for "${i.name}" using bulk mode.`)}}async processImage(t){if(!this.plugin.settings.openaiApiKey)throw new Error("OpenAI API key is not set. Please configure it in the plugin settings.");let r=await this._getBase64FromFile(t);return this.plugin._callOpenAIWithImageData(r)}async _getBase64FromFile(t){return new Promise((r,n)=>{let i=new FileReader;i.onload=a=>{var l;(l=a.target)!=null&&l.result?r(a.target.result):n(new Error("File data could not be read for base64 conversion."))},i.onerror=()=>n(new Error("Failed to read the image file for base64 conversion.")),i.readAsDataURL(t)})}async createNewNoteWithContent(t,r){let n=this.app.vault,i=t.trim(),a=r.endsWith(".md")?r:`${r}.md`;try{let l=await n.create(a,i);await this.app.workspace.getLeaf(!0).openFile(l)}catch(l){throw console.error("Could not create the new note:",l),l}}},vs=class extends O.PluginSettingTab{constructor(t,r){super(t,r);this.plugin=r}display(){let{containerEl:t}=this;t.empty(),t.createEl("h1",{text:"Picture to Markdown"});let r=new O.Setting(t).setName("OpenAI API Key").setDesc("Enter your OpenAI API Key (must have GPT access).").addText(n=>{n.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async i=>{this.plugin.settings.openaiApiKey=i,await this.plugin.saveSettings()}),n.inputEl.type="password"});r.controlEl.createEl("button",{text:"Show",cls:"show-hide-btn"},n=>{n.addEventListener("click",()=>{let i=r.settingEl.querySelector("input");i instanceof HTMLInputElement&&(i.type==="password"?(i.type="text",n.textContent="Hide"):(i.type="password",n.textContent="Show"))})})}};
